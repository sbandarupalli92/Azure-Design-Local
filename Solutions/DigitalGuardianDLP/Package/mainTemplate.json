{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Sanmit Biraj - v-sabiraj@microsoft.com",
    "comments": "Solution template for DigitalGuardianDLP"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Sentinel is setup"
      }
    },
    "formattedTimeNow": {
      "type": "string",
      "defaultValue": "[utcNow('g')]",
      "metadata": {
        "description": "Appended to workbook displayNames to make them unique"
      }
    },
    "workbook1-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the workbook"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "DigitalGuardianDLP",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "analytic1-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic2-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic3-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic4-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic5-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic6-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic7-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic8-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic9-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic10-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "connector1-name": {
      "type": "string",
      "defaultValue": "b3af32df-4d08-435f-85b0-1f3648f63429"
    }
  },
  "variables": {
    "DigitalGuardian_workbook": "DigitalGuardian_workbook",
    "_DigitalGuardian_workbook": "[variables('DigitalGuardian_workbook')]",
    "workbook-source": "[concat(resourceGroup().id, '/providers/Microsoft.OperationalInsights/workspaces/',parameters('workspace'))]",
    "_workbook-source": "[variables('workbook-source')]",
    "DigitalGuardianClassifiedDataInsecureTransfer_AnalyticalRules": "DigitalGuardianClassifiedDataInsecureTransfer_AnalyticalRules",
    "_DigitalGuardianClassifiedDataInsecureTransfer_AnalyticalRules": "[variables('DigitalGuardianClassifiedDataInsecureTransfer_AnalyticalRules')]",
    "DigitalGuardianExfiltrationOverDNS_AnalyticalRules": "DigitalGuardianExfiltrationOverDNS_AnalyticalRules",
    "_DigitalGuardianExfiltrationOverDNS_AnalyticalRules": "[variables('DigitalGuardianExfiltrationOverDNS_AnalyticalRules')]",
    "DigitalGuardianExfiltrationToFileShareServices_AnalyticalRules": "DigitalGuardianExfiltrationToFileShareServices_AnalyticalRules",
    "_DigitalGuardianExfiltrationToFileShareServices_AnalyticalRules": "[variables('DigitalGuardianExfiltrationToFileShareServices_AnalyticalRules')]",
    "DigitalGuardianFileSentToExternal_AnalyticalRules": "DigitalGuardianFileSentToExternal_AnalyticalRules",
    "_DigitalGuardianFileSentToExternal_AnalyticalRules": "[variables('DigitalGuardianFileSentToExternal_AnalyticalRules')]",
    "DigitalGuardianFileSentToExternalDomain_AnalyticalRules": "DigitalGuardianFileSentToExternalDomain_AnalyticalRules",
    "_DigitalGuardianFileSentToExternalDomain_AnalyticalRules": "[variables('DigitalGuardianFileSentToExternalDomain_AnalyticalRules')]",
    "DigitalGuardianFilesSentToExternalDomain_AnalyticalRules": "DigitalGuardianFilesSentToExternalDomain_AnalyticalRules",
    "_DigitalGuardianFilesSentToExternalDomain_AnalyticalRules": "[variables('DigitalGuardianFilesSentToExternalDomain_AnalyticalRules')]",
    "DigitalGuardianMultipleIncidentsFromUser_AnalyticalRules": "DigitalGuardianMultipleIncidentsFromUser_AnalyticalRules",
    "_DigitalGuardianMultipleIncidentsFromUser_AnalyticalRules": "[variables('DigitalGuardianMultipleIncidentsFromUser_AnalyticalRules')]",
    "DigitalGuardianPossibleProtocolAbuse_AnalyticalRules": "DigitalGuardianPossibleProtocolAbuse_AnalyticalRules",
    "_DigitalGuardianPossibleProtocolAbuse_AnalyticalRules": "[variables('DigitalGuardianPossibleProtocolAbuse_AnalyticalRules')]",
    "DigitalGuardianUnexpectedProtocol_AnalyticalRules": "DigitalGuardianUnexpectedProtocol_AnalyticalRules",
    "_DigitalGuardianUnexpectedProtocol_AnalyticalRules": "[variables('DigitalGuardianUnexpectedProtocol_AnalyticalRules')]",
    "DigitalGuardianViolationNotBlocked_AnalyticalRules": "DigitalGuardianViolationNotBlocked_AnalyticalRules",
    "_DigitalGuardianViolationNotBlocked_AnalyticalRules": "[variables('DigitalGuardianViolationNotBlocked_AnalyticalRules')]",
    "DigitalGuardianDomains_HuntingQueries": "DigitalGuardianDomains_HuntingQueries",
    "_DigitalGuardianDomains_HuntingQueries": "[variables('DigitalGuardianDomains_HuntingQueries')]",
    "workspace-dependency": "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspace'))]",
    "DigitalGuardianFilesSentByUsers_HuntingQueries": "DigitalGuardianFilesSentByUsers_HuntingQueries",
    "_DigitalGuardianFilesSentByUsers_HuntingQueries": "[variables('DigitalGuardianFilesSentByUsers_HuntingQueries')]",
    "DigitalGuardianIncidentsByUser_HuntingQueries": "DigitalGuardianIncidentsByUser_HuntingQueries",
    "_DigitalGuardianIncidentsByUser_HuntingQueries": "[variables('DigitalGuardianIncidentsByUser_HuntingQueries')]",
    "DigitalGuardianInsecureProtocolSources_HuntingQueries": "DigitalGuardianInsecureProtocolSources_HuntingQueries",
    "_DigitalGuardianInsecureProtocolSources_HuntingQueries": "[variables('DigitalGuardianInsecureProtocolSources_HuntingQueries')]",
    "DigitalGuardianInspectedFiles_HuntingQueries": "DigitalGuardianInspectedFiles_HuntingQueries",
    "_DigitalGuardianInspectedFiles_HuntingQueries": "[variables('DigitalGuardianInspectedFiles_HuntingQueries')]",
    "DigitalGuardianNewIncidents_HuntingQueries": "DigitalGuardianNewIncidents_HuntingQueries",
    "_DigitalGuardianNewIncidents_HuntingQueries": "[variables('DigitalGuardianNewIncidents_HuntingQueries')]",
    "DigitalGuardianRareDestinationPorts_HuntingQueries": "DigitalGuardianRareDestinationPorts_HuntingQueries",
    "_DigitalGuardianRareDestinationPorts_HuntingQueries": "[variables('DigitalGuardianRareDestinationPorts_HuntingQueries')]",
    "DigitalGuardianRareNetworkProtocols_HuntingQueries": "DigitalGuardianRareNetworkProtocols_HuntingQueries",
    "_DigitalGuardianRareNetworkProtocols_HuntingQueries": "[variables('DigitalGuardianRareNetworkProtocols_HuntingQueries')]",
    "DigitalGuardianRareUrls_HuntingQueries": "DigitalGuardianRareUrls_HuntingQueries",
    "_DigitalGuardianRareUrls_HuntingQueries": "[variables('DigitalGuardianRareUrls_HuntingQueries')]",
    "DigitalGuardianUrlByUser_HuntingQueries": "DigitalGuardianUrlByUser_HuntingQueries",
    "_DigitalGuardianUrlByUser_HuntingQueries": "[variables('DigitalGuardianUrlByUser_HuntingQueries')]",
    "DigitalGuardianDLPEvent_Parser": "DigitalGuardianDLPEvent_Parser",
    "_DigitalGuardianDLPEvent_Parser": "[variables('DigitalGuardianDLPEvent_Parser')]",
    "connector1-source": "[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.OperationalInsights/workspaces/',parameters('workspace'),'/providers/Microsoft.SecurityInsights/dataConnectors/',parameters('connector1-name'))]",
    "_connector1-source": "[variables('connector1-source')]",
    "DigitalGuardianDLPConnector": "DigitalGuardianDLPConnector",
    "_DigitalGuardianDLPConnector": "[variables('DigitalGuardianDLPConnector')]",
    "sourceId": "azuresentinel.azure-sentinel-solution-digitalguardiandlp",
    "_sourceId": "[variables('sourceId')]"
  },
  "resources": [
    {
      "type": "Microsoft.Insights/workbooks",
      "name": "[parameters('workbook1-id')]",
      "location": "[parameters('workspace-location')]",
      "kind": "shared",
      "apiVersion": "2020-02-12",
      "properties": {
        "displayName": "[concat(parameters('workbook1-name'), ' - ', parameters('formattedTimeNow'))]",
        "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"**NOTE**: This data connector depends on a parser based on Kusto Function **DigitalGuardianDLPEvent** to work as expected. [Follow steps to get this Kusto Function](https://aka.ms/sentinel-DigitalGuardian-parser)\"},\"name\":\"text - 8\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"cd8447d9-b096-4673-92d8-2a1e8291a125\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"description\":\"Sets the time name for analysis\",\"value\":{\"durationMs\":7776000000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":86400000},{\"durationMs\":604800000},{\"durationMs\":2592000000},{\"durationMs\":7776000000}]},\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 11\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"DigitalGuardianDLPEvent\\r\\n| make-series TotalEvents = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain};\",\"size\":0,\"title\":\"Events Over Time\",\"color\":\"green\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\",\"graphSettings\":{\"type\":0}},\"customWidth\":\"45\",\"name\":\"query - 12\",\"styleSettings\":{\"maxWidth\":\"55\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"DigitalGuardianDLPEvent\\n| summarize count() by NetworkApplicationProtocol\",\"size\":3,\"title\":\"Network Protocols\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"30\",\"name\":\"query - 10\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"Data Connector Statistics\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"DigitalGuardianDLPEvent\\r\\n| where isnotempty(SrcIpAddr)\\r\\n| summarize dcount(SrcIpAddr)\",\"size\":3,\"title\":\"IP Addresses\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"card\",\"textSettings\":{\"style\":\"bignumber\"}},\"customWidth\":\"50\",\"name\":\"query - 3\",\"styleSettings\":{\"margin\":\"10\",\"padding\":\"10\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"DigitalGuardianDLPEvent\\n| where isnotempty(SrcUserName)\\n| summarize dcount(SrcUserName)\",\"size\":3,\"title\":\"Users\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"card\",\"textSettings\":{\"style\":\"bignumber\"}},\"customWidth\":\"50\",\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"DigitalGuardianDLPEvent\\n| where isnotempty(SrcIpAddr)\\n| summarize dcount(SrcIpAddr)\",\"size\":3,\"title\":\"Hosts\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"card\",\"textSettings\":{\"style\":\"bignumber\"}},\"customWidth\":\"50\",\"name\":\"query - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"DigitalGuardianDLPEvent\\n| where isnotempty(IncidentId)\\n| summarize dcount(IncidentId)\",\"size\":3,\"title\":\"Total Incidents\",\"noDataMessage\":\"0\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"card\",\"textSettings\":{\"style\":\"bignumber\"}},\"customWidth\":\"50\",\"name\":\"query - 3\"}]},\"customWidth\":\"20\",\"name\":\"group - 11\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"DigitalGuardianDLPEvent\\r\\n| where isnotempty(SrcIpAddr)\\r\\n| summarize count() by SrcIpAddr\\r\\n| top 10 by count_\",\"size\":3,\"title\":\"Top Source Addresses\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"cat\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"secondaryContent\":{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"palette\":\"purple\"}},\"showBorder\":false}},\"customWidth\":\"35\",\"name\":\"query - 0\",\"styleSettings\":{\"maxWidth\":\"30\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"DigitalGuardianDLPEvent\\n| where isnotempty(SrcUserName)\\n| summarize count() by SrcUserName\\n| top 10 by count_\",\"size\":3,\"title\":\"Top Users\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"35\",\"name\":\"query - 11\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"DigitalGuardianDLPEvent\\n| where isnotempty(http_url)\\n| extend u = parse_url(http_url)\\n| extend Domain = tostring(u.Host)\\n| summarize count() by Domain\\n| project Domain, EventCount=count_\",\"size\":3,\"title\":\"Top domains\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"rowLimit\":10}},\"customWidth\":\"30\",\"name\":\"query - 9\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"DigitalGuardianDLPEvent\\n| where isnotempty(DstUserName)\\n| summarize f = makeset(inspected_document) by DstUserName\\n| project Email = DstUserName, Files = f, FileCount = array_length(f)\",\"size\":0,\"title\":\"Top Recipients\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"rowLimit\":10},\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"User\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"TotalMailsReceived\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"secondaryContent\":{\"columnMatch\":\"Trend\",\"formatter\":10,\"formatOptions\":{\"palette\":\"magenta\"}},\"showBorder\":false}},\"customWidth\":\"40\",\"name\":\"query - 10\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"DigitalGuardianDLPEvent\\r\\n| where isnotempty(inspected_document)\\r\\n| order by TimeGenerated\\r\\n| project File=inspected_document, User=SrcUserName, Policy=MatchedPolicies\",\"size\":0,\"title\":\"Inspected files\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"Total Bytes (KB)\",\"formatter\":8,\"formatOptions\":{\"palette\":\"greenRed\"}}],\"filter\":true},\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"User\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"TrafficVolume(MB)\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"secondaryContent\":{\"columnMatch\":\"Trend\",\"formatter\":21,\"formatOptions\":{\"palette\":\"blue\"}},\"showBorder\":false}},\"customWidth\":\"55\",\"name\":\"query - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"DigitalGuardianDLPEvent\\r\\n| where isnotempty(IncidentStatus)\\r\\n| extend inc_act = split(IncidentStatus, ',')\\r\\n| where inc_act has 'New'\\r\\n| order by TimeGenerated\\r\\n| project TimeGenerated, User=SrcUserName, File=inspected_document, MatchedPolicies\\r\\n\",\"size\":0,\"title\":\"New Incidents\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"filter\":true}},\"name\":\"query - 1\"}],\"fromTemplateId\":\"sentinel-DigitalGuardianWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
        "version": "1.0",
        "sourceId": "[variables('_workbook-source')]",
        "category": "sentinel"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic1-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects sensitive data transfer over insecure channel.",
        "displayName": "Digital Guardian - Sensitive data transfer over insecure channel",
        "enabled": false,
        "query": "DigitalGuardianDLPEvent\n| where isnotempty(MatchedPolicies)\n| where isnotempty(inspected_document)\n| where NetworkApplicationProtocol =~ 'HTTP'\n| extend AccountCustomEntity = SrcUserName, IPCustomEntity = SrcIpAddr\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Exfiltration"
        ],
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "identifier": "Name",
                "columnName": "AccountCustomEntity"
              }
            ],
            "entityType": "Account"
          },
          {
            "fieldMappings": [
              {
                "identifier": "Address",
                "columnName": "IPCustomEntity"
              }
            ],
            "entityType": "IP"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic2-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects exfiltration using DNS protocol.",
        "displayName": "Digital Guardian - Exfiltration using DNS protocol",
        "enabled": false,
        "query": "DigitalGuardianDLPEvent\n| where DstPortNumber == 53\n| extend AccountCustomEntity = SrcUserName\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "High",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Exfiltration"
        ],
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "identifier": "Name",
                "columnName": "AccountCustomEntity"
              }
            ],
            "entityType": "Account"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic3-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects exfiltration to online fileshare.",
        "displayName": "Digital Guardian - Exfiltration to online fileshare",
        "enabled": false,
        "query": "let threshold = 10;\nDigitalGuardianDLPEvent\n| where isnotempty(inspected_document)\n| where http_url contains 'dropbox' or http_url contains 'mega.nz'\n| summarize f = dcount(inspected_document) by SrcUserName, bin(TimeGenerated, 30m)\n| where f >= threshold\n| extend AccountCustomEntity = SrcUserName\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "High",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Exfiltration"
        ],
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "identifier": "Name",
                "columnName": "AccountCustomEntity"
              }
            ],
            "entityType": "Account"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic4-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects exfiltration to private email.",
        "displayName": "Digital Guardian - Exfiltration to private email",
        "enabled": false,
        "query": "DigitalGuardianDLPEvent\n| where NetworkApplicationProtocol =~ 'SMTP'\n| where isnotempty(inspected_document)\n| extend s_user = substring(SrcUserName, 0, indexof(SrcUserName, '@'))\n| extend d_user = substring(DstUserName, 0, indexof(DstUserName, '@'))\n| extend s_domain = extract(@'@(.*)', 1, SrcUserName)\n| extend d_domain = extract(@'@(.*)', 1, DstUserName)\n| where s_domain != d_domain\n| where s_user == d_user\n| extend AccountCustomEntity = SrcUserName\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "High",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Exfiltration"
        ],
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "identifier": "Name",
                "columnName": "AccountCustomEntity"
              }
            ],
            "entityType": "Account"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic5-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects exfiltration to external domain.",
        "displayName": "Digital Guardian - Exfiltration to external domain",
        "enabled": false,
        "query": "let corp_domain = dynamic(['example.com']);     //add all corporate domains to this list\nDigitalGuardianDLPEvent\n| where NetworkApplicationProtocol =~ 'SMTP'\n| where isnotempty(inspected_document)\n| extend s_domain = extract(@'@(.*)', 1, SrcUserName)\n| extend d_domain = extract(@'@(.*)', 1, DstUserName)\n| where s_domain in~ (corp_domain)\n| where d_domain !in (corp_domain)\n| extend AccountCustomEntity = SrcUserName\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Exfiltration"
        ],
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "identifier": "Name",
                "columnName": "AccountCustomEntity"
              }
            ],
            "entityType": "Account"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic6-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects bulk exfiltration to external domain.",
        "displayName": "Digital Guardian - Bulk exfiltration to external domain",
        "enabled": false,
        "query": "let threshold = 10;\nlet corp_domain = dynamic(['example.com']);\nDigitalGuardianDLPEvent\n| where NetworkApplicationProtocol =~ 'SMTP'\n| where isnotempty(inspected_document)\n| extend s_domain = extract(@'@(.*)', 1, SrcUserName)\n| extend d_domain = extract(@'@(.*)', 1, DstUserName)\n| where s_domain in~ (corp_domain)\n| where d_domain !in (corp_domain)\n| summarize f = dcount(inspected_document) by SrcUserName, DstUserName, bin(TimeGenerated, 30m)\n| where  f >= threshold\n| extend AccountCustomEntity = SrcUserName\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Exfiltration"
        ],
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "identifier": "Name",
                "columnName": "AccountCustomEntity"
              }
            ],
            "entityType": "Account"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic7-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects multiple incidents from user.",
        "displayName": "Digital Guardian - Multiple incidents from user",
        "enabled": false,
        "query": "let threshold = 2;\nDigitalGuardianDLPEvent\n| where isnotempty(MatchedPolicies)\n| summarize count() by SrcUserName, bin(TimeGenerated, 30m)\n| where count_ >= threshold\n| extend AccountCustomEntity = SrcUserName\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "High",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Exfiltration"
        ],
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "identifier": "Name",
                "columnName": "AccountCustomEntity"
              }
            ],
            "entityType": "Account"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic8-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects possible SMTP protocol abuse.",
        "displayName": "Digital Guardian - Possible SMTP protocol abuse",
        "enabled": false,
        "query": "DigitalGuardianDLPEvent\n| where NetworkApplicationProtocol =~ 'SMTP'\n| where DstPortNumber != 25\n| extend AccountCustomEntity = SrcUserName\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "High",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Exfiltration"
        ],
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "identifier": "Name",
                "columnName": "AccountCustomEntity"
              }
            ],
            "entityType": "Account"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic9-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects RDP protocol usage for data transfer which is not common.",
        "displayName": "Digital Guardian - Unexpected protocol",
        "enabled": false,
        "query": "DigitalGuardianDLPEvent\n| where DstPortNumber == 3389\n| extend AccountCustomEntity = SrcUserName\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "High",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Exfiltration"
        ],
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "identifier": "Name",
                "columnName": "AccountCustomEntity"
              }
            ],
            "entityType": "Account"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic10-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects when incident has not block action.",
        "displayName": "Digital Guardian - Incident with not blocked action",
        "enabled": false,
        "query": "DigitalGuardianDLPEvent\n| where isnotempty(IncidentStatus)\n| extend inc_act = split(IncidentStatus, ',')\n| where inc_act has 'New'\n| where inc_act !contains 'Block'\n| extend AccountCustomEntity = SrcUserName\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "High",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Exfiltration"
        ],
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "identifier": "Name",
                "columnName": "AccountCustomEntity"
              }
            ],
            "entityType": "Account"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2020-08-01",
      "name": "[parameters('workspace')]",
      "location": "[parameters('workspace-location')]",
      "resources": [
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "DigitalGuardianDLP Hunting Query 1",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Digital Guardian - Incident domains",
            "category": "Hunting Queries",
            "query": "DigitalGuardianDLPEvent\n| where TimeGenerated > ago(24h)\n| where isnotempty(http_url)\n| extend u = parse_url(http_url)\n| extend domain=u.Host\n| summarize count() by tostring(domain), SrcUserName\n| extend AccountCustomEntity = SrcUserName\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for incident domains."
              },
              {
                "name": "tactics",
                "value": "Exfiltration"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "DigitalGuardianDLP Hunting Query 2",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Digital Guardian - Files sent by users",
            "category": "Hunting Queries",
            "query": "DigitalGuardianDLPEvent\n| where TimeGenerated > ago(24h)\n| where isnotempty(inspected_document)\n| summarize Files = makeset(inspected_document) by SrcUserName\n| extend AccountCustomEntity = SrcUserName\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for files sent by users."
              },
              {
                "name": "tactics",
                "value": "Exfiltration"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "DigitalGuardianDLP Hunting Query 3",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Digital Guardian - Users' incidents",
            "category": "Hunting Queries",
            "query": "DigitalGuardianDLPEvent\n| where TimeGenerated > ago(24h)\n| where isnotempty(IncidentStatus)\n| where inc_act has 'New'\n| summarize makeset(IncidentsUrl) by SrcUserName\n| extend AccountCustomEntity = SrcUserName\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for users' incidents."
              },
              {
                "name": "tactics",
                "value": "Exfiltration"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "DigitalGuardianDLP Hunting Query 4",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Digital Guardian - Insecure file transfer sources",
            "category": "Hunting Queries",
            "query": "DigitalGuardianDLPEvent\n| where TimeGenerated > ago(24h)\n| where NetworkApplicationProtocol in~ ('HTTP', 'FTP')\n| project SrcUserName, SrcIpAddr, DstIpAddr, DstPortNumber, File=inspected_document\n| extend AccountCustomEntity = SrcUserName\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for insecure file transfer sources."
              },
              {
                "name": "tactics",
                "value": "Exfiltration"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "DigitalGuardianDLP Hunting Query 5",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Digital Guardian - Inspected files",
            "category": "Hunting Queries",
            "query": "DigitalGuardianDLPEvent\n| where TimeGenerated > ago(24h)\n| where isnotempty(inspected_document)\n| project SrcUserName, DstUserName, File=inspected_document, MatchedPolicies\n| extend AccountCustomEntity = SrcUserName\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for inspected files."
              },
              {
                "name": "tactics",
                "value": "Exfiltration"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "DigitalGuardianDLP Hunting Query 6",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Digital Guardian - New incidents",
            "category": "Hunting Queries",
            "query": "DigitalGuardianDLPEvent\n| where TimeGenerated > ago(24h)\n| where isnotempty(IncidentStatus)\n| extend inc_act = split(IncidentStatus, ',')\n| where inc_act has 'New'\n| extend AccountCustomEntity = SrcUserName\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for new incidents."
              },
              {
                "name": "tactics",
                "value": "Exfiltration"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "DigitalGuardianDLP Hunting Query 7",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Digital Guardian - Rare destination ports",
            "category": "Hunting Queries",
            "query": "DigitalGuardianDLPEvent\n| where TimeGenerated > ago(24h)\n| summarize count() by DstIpAddr, DstPortNumber\n| order by count_ asc\n| top 10 by count_\n| extend IPCustomEntity = DstIpAddr\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for rare destination ports."
              },
              {
                "name": "tactics",
                "value": "Exfiltration"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "DigitalGuardianDLP Hunting Query 8",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Digital Guardian - Rare network protocols",
            "category": "Hunting Queries",
            "query": "DigitalGuardianDLPEvent\n| where TimeGenerated > ago(24h)\n| where isnotempty(NetworkApplicationProtocol)\n| summarize count() by SrcIpAddr, SrcUserName\n| order by count_ asc\n| top 10 by count_\n| extend AccountCustomEntity = SrcUserName, IPCustomEntity = SrcIpAddr\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches rare network protocols."
              },
              {
                "name": "tactics",
                "value": "Exfiltration"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "DigitalGuardianDLP Hunting Query 9",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Digital Guardian - Rare Urls",
            "category": "Hunting Queries",
            "query": "DigitalGuardianDLPEvent\n| where TimeGenerated > ago(24h)\n| where isnotempty(http_url)\n| summarize count() by SrcUserName, http_url\n| order by count_ asc\n| top 10 by count_\n| extend AccountCustomEntity = SrcUserName\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for rare Urls."
              },
              {
                "name": "tactics",
                "value": "Exfiltration"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "DigitalGuardianDLP Hunting Query 10",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Digital Guardian - Urls used",
            "category": "Hunting Queries",
            "query": "DigitalGuardianDLPEvent\n| where TimeGenerated > ago(24h)\n| where isnotempty(http_url)\n| project SrcUserName, DstUserName, URL=http_url, MatchedPolicies\n| extend AccountCustomEntity = SrcUserName\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for URLs used."
              },
              {
                "name": "tactics",
                "value": "Exfiltration"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "DigitalGuardianDLP Data Parser",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "DigitalGuardianDLP Data Parser",
            "category": "Samples",
            "functionAlias": "DigitalGuardianDLPEvent",
            "query": "\nSyslog\r\n| where SyslogMessage contains 'managed_device_id' and SyslogMessage contains 'number_of_incidents'\r\n| mv-apply ExtractedFields = extract_all(@'\\s(?P<key>[a-zA-Z0-9-_]+)=\\\"?(?P<value>[a-zA-Z0-9-_:/@.,#{}>< ]+)\\\"?', dynamic([\"key\",\"value\"]), SyslogMessage) on (\r\n    project packed = pack(tostring(ExtractedFields[0]), tostring(ExtractedFields[1]))\r\n    | summarize bag = make_bag(packed)\r\n)\r\n| evaluate bag_unpack(bag)\r\n| extend EventEndTime=todatetime(timestamp)\r\n| project-away timestamp\r\n| project-rename DvcAvtion=action_taken\r\n                , DstUserName=destination\r\n                , DstIpAddr=destination_ip\r\n                , DstPortNumber=destination_port\r\n                , IncidentId=incident_id\r\n                , IncidentStatus=incident_status\r\n                , IncidentsUrl=incidents_url\r\n                , MatchedPolicies=matched_policies_by_severity\r\n                , EventCount=number_of_incidents\r\n                , NetworkApplicationProtocol=protocol\r\n                , SrcUserName=source\r\n                , SrcIpAddr=source_ip\r\n                , SrcPortNumber=source_port\r\n",
            "version": 1
          }
        }
      ]
    },
    {
      "id": "[variables('_connector1-source')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('connector1-name'))]",
      "apiVersion": "2021-03-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "location": "[parameters('workspace-location')]",
      "kind": "GenericUI",
      "properties": {
        "connectorUiConfig": {
          "title": "Digital Guardian Data Loss Prevention",
          "publisher": "Digital Guardian",
          "descriptionMarkdown": "[Digital Guardian Data Loss Prevention (DLP)](https://digitalguardian.com/platform-overview) data connector provides the capability to ingest Digital Guardian DLP logs into Azure Sentinel.",
          "graphQueries": [
            {
              "metricName": "Total data received",
              "legend": "DigitalGuardianDLPEvent",
              "baseQuery": "DigitalGuardianDLPEvent"
            }
          ],
          "sampleQueries": [
            {
              "description": "Top 10 Clients (Source IP)",
              "query": "DigitalGuardianDLPEvent\n | where notempty(SrcIpAddr)\n | summarize count() by SrcIpAddr\n | top 10 by count_"
            }
          ],
          "dataTypes": [
            {
              "name": "Syslog (DigitalGuardianDLPEvent)",
              "lastDataReceivedQuery": "DigitalGuardianDLPEvent\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriterias": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "DigitalGuardianDLPEvent\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)"
              ]
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": true
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "write permission is required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "read": true,
                  "write": true,
                  "delete": true
                }
              },
              {
                "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key)",
                "providerDisplayName": "Keys",
                "scope": "Workspace",
                "requiredPermissions": {
                  "action": true
                }
              }
            ]
          },
          "instructionSteps": [
            {
              "description": ">**NOTE:** This data connector depends on a parser based on a Kusto Function to work as expected [**DigitalGuardianDLPEvent**](https://aka.ms/sentinel-DigitalGuardianDLP-parser) which is deployed with the Azure Sentinel Solution."
            },
            {
              "description": "Follow these steps to configure Digital Guardian to forward logs via Syslog:\n\n1.1. Log in to the Digital Guardian Management Console.\n\n1.2. Select **Workspace** > **Data Export** > **Create Export**.\n\n1.3. From the **Data Sources** list, select **Alerts** or **Events** as the data source.\n\n1.4. From the **Export type** list, select **Syslog**.\n\n1.5. From the **Type list**, select **UDP** or **TCP** as the transport protocol.\n\n1.6. In the **Server** field, type the IP address of your Remote Syslog server.\n\n1.7. In the **Port** field, type 514 (or other port if your Syslog server was configured to use non-default port).\n\n1.8. From the **Severity Level** list, select a severity level.\n\n1.9. Select the **Is Active** check box.\n\n1.9. Click **Next**.\n\n1.10. From the list of available fields, add Alert or Event fields for your data export.\n\n1.11. Select a Criteria for the fields in your data export and click **Next**.\n\n1.12. Select a group for the criteria and click **Next**.\n\n1.13. Click **Test Query**.\n\n1.14. Click **Next**.\n\n1.15. Save the data export.",
              "title": "1. Configure Digital Guardian to forward logs via Syslog to remote server where you will install the agent."
            },
            {
              "description": "Install the agent on the Server to which the logs will be forwarded.\n\n> Logs on Linux or Windows servers are collected by **Linux** or **Windows** agents.",
              "instructions": [
                {
                  "parameters": {
                    "title": "Choose where to install the Linux agent:",
                    "instructionSteps": [
                      {
                        "title": "Install agent on Azure Linux Virtual Machine",
                        "description": "Select the machine to install the agent on and then click **Connect**.",
                        "instructions": [
                          {
                            "parameters": {
                              "linkType": "InstallAgentOnLinuxVirtualMachine"
                            },
                            "type": "InstallAgent"
                          }
                        ]
                      },
                      {
                        "title": "Install agent on a non-Azure Linux Machine",
                        "description": "Download the agent on the relevant machine and follow the instructions.",
                        "instructions": [
                          {
                            "parameters": {
                              "linkType": "InstallAgentOnLinuxNonAzure"
                            },
                            "type": "InstallAgent"
                          }
                        ]
                      }
                    ]
                  },
                  "type": "InstructionStepsGroup"
                }
              ],
              "title": "2. Install and onboard the agent for Linux or Windows"
            },
            {
              "instructions": [
                {
                  "parameters": {
                    "title": "Choose where to install the Windows agent:",
                    "instructionSteps": [
                      {
                        "title": "Install agent on Azure Windows Virtual Machine",
                        "description": "Select the machine to install the agent on and then click **Connect**.",
                        "instructions": [
                          {
                            "parameters": {
                              "linkType": "InstallAgentOnVirtualMachine"
                            },
                            "type": "InstallAgent"
                          }
                        ]
                      },
                      {
                        "title": "Install agent on a non-Azure Windows Machine",
                        "description": "Download the agent on the relevant machine and follow the instructions.",
                        "instructions": [
                          {
                            "parameters": {
                              "linkType": "InstallAgentOnNonAzure"
                            },
                            "type": "InstallAgent"
                          }
                        ]
                      }
                    ]
                  },
                  "type": "InstructionStepsGroup"
                }
              ]
            },
            {
              "description": "Open Log Analytics to check if the logs are received using the Syslog schema.\n\n>**NOTE:** It may take up to 15 minutes before new logs will appear in Syslog table.",
              "title": "3. Check logs in Azure Sentinel"
            }
          ],
          "additionalRequirementBanner": "This data connector depends on a parser based on a Kusto Function to work as expected [**DigitalGuardianDLPEvent**](https://aka.ms/sentinel-DigitalGuardianDLP-parser) which is deployed with the Azure Sentinel Solution."
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "version": "1.0.2",
        "kind": "Solution",
        "contentId": "[variables('_sourceId')]",
        "parentId": "[variables('_sourceId')]",
        "source": {
          "kind": "Solution",
          "name": "DigitalGuardianDLP",
          "sourceId": "[variables('_sourceId')]"
        },
        "author": {
          "name": "Sanmit Biraj",
          "email": "v-sabiraj@microsoft.com"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "Workbook",
              "contentId": "[variables('_DigitalGuardian_workbook')]",
              "version": "1.0.2"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_DigitalGuardianClassifiedDataInsecureTransfer_AnalyticalRules')]",
              "version": "1.0.2"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_DigitalGuardianExfiltrationOverDNS_AnalyticalRules')]",
              "version": "1.0.2"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_DigitalGuardianExfiltrationToFileShareServices_AnalyticalRules')]",
              "version": "1.0.2"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_DigitalGuardianFileSentToExternal_AnalyticalRules')]",
              "version": "1.0.2"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_DigitalGuardianFileSentToExternalDomain_AnalyticalRules')]",
              "version": "1.0.2"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_DigitalGuardianFilesSentToExternalDomain_AnalyticalRules')]",
              "version": "1.0.2"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_DigitalGuardianMultipleIncidentsFromUser_AnalyticalRules')]",
              "version": "1.0.2"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_DigitalGuardianPossibleProtocolAbuse_AnalyticalRules')]",
              "version": "1.0.2"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_DigitalGuardianUnexpectedProtocol_AnalyticalRules')]",
              "version": "1.0.2"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_DigitalGuardianViolationNotBlocked_AnalyticalRules')]",
              "version": "1.0.2"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_DigitalGuardianDomains_HuntingQueries')]",
              "version": "1.0.2"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_DigitalGuardianFilesSentByUsers_HuntingQueries')]",
              "version": "1.0.2"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_DigitalGuardianIncidentsByUser_HuntingQueries')]",
              "version": "1.0.2"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_DigitalGuardianInsecureProtocolSources_HuntingQueries')]",
              "version": "1.0.2"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_DigitalGuardianInspectedFiles_HuntingQueries')]",
              "version": "1.0.2"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_DigitalGuardianNewIncidents_HuntingQueries')]",
              "version": "1.0.2"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_DigitalGuardianRareDestinationPorts_HuntingQueries')]",
              "version": "1.0.2"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_DigitalGuardianRareNetworkProtocols_HuntingQueries')]",
              "version": "1.0.2"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_DigitalGuardianRareUrls_HuntingQueries')]",
              "version": "1.0.2"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_DigitalGuardianUrlByUser_HuntingQueries')]",
              "version": "1.0.2"
            },
            {
              "kind": "Parser",
              "contentId": "[variables('_DigitalGuardianDLPEvent_Parser')]",
              "version": "1.0.2"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_DigitalGuardianDLPConnector')]",
              "version": "1.0.2"
            }
          ]
        },
        "firstPublishDate": "2021-07-23",
        "providers": [
          "Digital Guardian"
        ],
        "categories": {
          "domains": [
            "Security – Information Protection"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_sourceId'))]"
    }
  ],
  "outputs": {}
}
