{
   "$schema":"https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
   "contentVersion":"1.0.0.0",
   "parameters":{
      "PlaybookName":{
         "defaultValue":"AbuseIPDB-BlacklistIpToThreatIntelligence",
         "type":"String"
      }
   },
   "variables":{
      "AbuseIPDBConnectionName":"[concat('abuseipdb-', parameters('PlaybookName'))]",
      "ThreatIntelligenceConnectionName":"[concat('ThreatIntelligence-connection-', parameters('PlaybookName'))]",
      "customApis_AbuseIPDB":"AbuseIPDBAPI"
   },
   "resources":[
      {
         "type":"Microsoft.Web/connections",
         "apiVersion":"2016-06-01",
         "name":"[variables('AbuseIPDBConnectionName')]",
         "location":"[resourceGroup().location]",
         "properties":{
            "displayName":"[variables('AbuseIPDBConnectionName')]",
            "customParameterValues":{
               
            },
            "api":{
               "id":"[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', variables('customApis_AbuseIPDB'))]"
            }
         }
      },
      {
         "type":"Microsoft.Web/connections",
         "apiVersion":"2016-06-01",
         "name":"[variables('ThreatIntelligenceConnectionName')]",
         "location":"[resourceGroup().location]",
         "kind":"V1",
         "properties":{
            "displayName":"[variables('ThreatIntelligenceConnectionName')]",
            "customParameterValues":{
               
            },
            "api":{
               "id":"[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/microsoftgraphsecurity')]"
            }
         }
      },
      {
         "type":"Microsoft.Logic/workflows",
         "apiVersion":"2017-07-01",
         "name":"[parameters('PlaybookName')]",
         "location":"[resourceGroup().location]",
         "dependsOn":[
            "[resourceId('Microsoft.Web/connections', variables('AbuseIPDBConnectionName'))]",
            "[resourceId('Microsoft.Web/connections', variables('ThreatIntelligenceConnectionName'))]"
         ],
         "properties":{
            "state":"Enabled",
            "definition":{
               "$schema":"https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
               "actions":{
                  "BLACKLIST_Endpoint":{
                     "inputs":{
                        "host":{
                           "connection":{
                              "name":"@parameters('$connections')['AbuseIPDBAPI']['connectionId']"
                           }
                        },
                        "method":"get",
                        "path":"/blacklist",
                        "queries":{
                           "confidenceMinimum":25,
                           "limit":10000
                        }
                     },
                     "runAfter":{
                        
                     },
                     "type":"ApiConnection"
                  },
                  "Initialize_Results_Array":{
                     "inputs":{
                        "variables":[
                           {
                              "name":"Results_Array",
                              "type":"array",
                              "value":"@body('Select')"
                           }
                        ]
                     },
                     "runAfter":{
                        "Select":[
                           "Succeeded"
                        ]
                     },
                     "type":"InitializeVariable"
                  },
                  "Initialize_Temp_Array":{
                     "inputs":{
                        "variables":[
                           {
                              "name":"Temp_Array",
                              "type":"array"
                           }
                        ]
                     },
                     "runAfter":{
                        "Initialize_Working_Array":[
                           "Succeeded"
                        ]
                     },
                     "type":"InitializeVariable"
                  },
                  "Initialize_Working_Array":{
                     "inputs":{
                        "variables":[
                           {
                              "name":"Working_array",
                              "type":"array"
                           }
                        ]
                     },
                     "runAfter":{
                        "Initialize_Results_Array":[
                           "Succeeded"
                        ]
                     },
                     "type":"InitializeVariable"
                  },
                  "Select":{
                     "inputs":{
                        "from":"@body('BLACKLIST_Endpoint')?['data']",
                        "select":{
                           "action":"alert",
                           "confidence":"@item()['abuseConfidenceScore']",
                           "description":"AbuseIPDB BLACKLIST Indicator ",
                           "expirationDateTime":"@addDays(utcNow(),7)",
                           "lastReportedDateTime":"@item()['lastReportedAt']",
                           "networkDestinationIPv4":"@item()['ipAddress']",
                           "targetProduct":"Azure Sentinel",
                           "threatType":"WatchList",
                           "tlpLevel":"unknown"
                        }
                     },
                     "runAfter":{
                        "BLACKLIST_Endpoint":[
                           "Succeeded"
                        ]
                     },
                     "type":"Select"
                  },
                  "Until":{
                     "actions":{
                        "Remove_Items_From_Results_Array":{
                           "inputs":{
                              "name":"Results_Array",
                              "value":"@variables('Temp_Array')"
                           },
                           "runAfter":{
                              "Set_Temp_Array":[
                                 "Succeeded"
                              ]
                           },
                           "type":"SetVariable"
                        },
                        "Set_Temp_Array":{
                           "inputs":{
                              "name":"Temp_Array",
                              "value":"@skip(variables('Results_Array'),100)"
                           },
                           "runAfter":{
                              "Submit_multiple_tiIndicators":[
                                 "Succeeded"
                              ]
                           },
                           "type":"SetVariable"
                        },
                        "Set_Working_Array":{
                           "inputs":{
                              "name":"Working_array",
                              "value":"@take(variables('Results_Array'), 100)"
                           },
                           "runAfter":{
                              
                           },
                           "type":"SetVariable"
                        },
                        "Submit_multiple_tiIndicators":{
                           "inputs":{
                              "body":{
                                 "value":"@variables('Working_array')"
                              },
                              "host":{
                                 "connection":{
                                    "name":"@parameters('$connections')['microsoftgraphsecurity']['connectionId']"
                                 }
                              },
                              "method":"post",
                              "path":"/beta/security/tiIndicators/submitTiIndicators"
                           },
                           "runAfter":{
                              "Set_Working_Array":[
                                 "Succeeded"
                              ]
                           },
                           "type":"ApiConnection"
                        }
                     },
                     "expression":"@equals(length(variables('Results_Array')), 0)",
                     "limit":{
                        "count":5000,
                        "timeout":"PT1H"
                     },
                     "runAfter":{
                        "Initialize_Temp_Array":[
                           "Succeeded"
                        ]
                     },
                     "type":"Until"
                  }
               },
               "contentVersion":"1.0.0.0",
               "outputs":{
                  
               },
               "parameters":{
                  "$connections":{
                     "defaultValue":{
                        
                     },
                     "type":"Object"
                  }
               },
               "triggers":{
                  "Recurrence":{
                     "evaluatedRecurrence":{
                        "frequency":"Day",
                        "interval":1
                     },
                     "recurrence":{
                        "frequency":"Day",
                        "interval":1
                     },
                     "type":"Recurrence"
                  }
               }
            },
            "parameters":{
               "$connections":{
                  "value":{
                     "AbuseIPDBAPI":{
                        "connectionName":"[variables('AbuseIPDBConnectionName')]",
                        "connectionId":"[resourceId('Microsoft.Web/connections', variables('AbuseIPDBConnectionName'))]",
                        "id":"[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.Web/customApis/', variables('customApis_AbuseIPDB'))]"
                     },
                     "microsoftgraphsecurity":{
                        "connectionId":"[resourceId('Microsoft.Web/connections', variables('ThreatIntelligenceConnectionName'))]",
                        "connectionName":"[variables('ThreatIntelligenceConnectionName')]",
                        "id":"[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/microsoftgraphsecurity')]"
                     }
                  }
               }
            }
         }
      }
   ]
}