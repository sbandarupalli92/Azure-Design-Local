{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Manoj Arimanda - v-marimanda@microsoft.com",
    "comments": "Solution template for OracleWebLogicServer"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Sentinel is setup"
      }
    },
    "formattedTimeNow": {
      "type": "string",
      "defaultValue": "[utcNow('g')]",
      "metadata": {
        "description": "Appended to workbook displayNames to make them unique"
      }
    },
    "workbook1-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the workbook"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "OracleWebLogicServer",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "connector1-name": {
      "type": "string",
      "defaultValue": "e797512b-e874-4386-a288-b53cac9966c5"
    },
    "analytic1-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic2-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic3-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic4-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic5-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic6-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic7-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic8-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic9-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic10-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    }
  },
  "variables": {
    "OracleWorkbook_workbook": "OracleWorkbook_workbook",
    "_OracleWorkbook_workbook": "[variables('OracleWorkbook_workbook')]",
    "workbook-source": "[concat(resourceGroup().id, '/providers/Microsoft.OperationalInsights/workspaces/',parameters('workspace'))]",
    "_workbook-source": "[variables('workbook-source')]",
    "workspace-dependency": "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspace'))]",
    "OracleWebLogicServerEvent_Parser": "OracleWebLogicServerEvent_Parser",
    "_OracleWebLogicServerEvent_Parser": "[variables('OracleWebLogicServerEvent_Parser')]",
    "OracleWebLogic403RequestsFiles_HuntingQueries": "OracleWebLogic403RequestsFiles_HuntingQueries",
    "_OracleWebLogic403RequestsFiles_HuntingQueries": "[variables('OracleWebLogic403RequestsFiles_HuntingQueries')]",
    "OracleWebLogicAbnormalRequestSize_HuntingQueries": "OracleWebLogicAbnormalRequestSize_HuntingQueries",
    "_OracleWebLogicAbnormalRequestSize_HuntingQueries": "[variables('OracleWebLogicAbnormalRequestSize_HuntingQueries')]",
    "OracleWebLogicCriticalEventSeverity_HuntingQueries": "OracleWebLogicCriticalEventSeverity_HuntingQueries",
    "_OracleWebLogicCriticalEventSeverity_HuntingQueries": "[variables('OracleWebLogicCriticalEventSeverity_HuntingQueries')]",
    "OracleWebLogicErrors_HuntingQueries": "OracleWebLogicErrors_HuntingQueries",
    "_OracleWebLogicErrors_HuntingQueries": "[variables('OracleWebLogicErrors_HuntingQueries')]",
    "OracleWebLogicFilesErrorRequests_HuntingQueries": "OracleWebLogicFilesErrorRequests_HuntingQueries",
    "_OracleWebLogicFilesErrorRequests_HuntingQueries": "[variables('OracleWebLogicFilesErrorRequests_HuntingQueries')]",
    "OracleWebLogicRareUAWithClientErrors_HuntingQueries": "OracleWebLogicRareUAWithClientErrors_HuntingQueries",
    "_OracleWebLogicRareUAWithClientErrors_HuntingQueries": "[variables('OracleWebLogicRareUAWithClientErrors_HuntingQueries')]",
    "OracleWebLogicRareURLsRequested_HuntingQueries": "OracleWebLogicRareURLsRequested_HuntingQueries",
    "_OracleWebLogicRareURLsRequested_HuntingQueries": "[variables('OracleWebLogicRareURLsRequested_HuntingQueries')]",
    "OracleWebLogicUncommonUserAgents_HuntingQueries": "OracleWebLogicUncommonUserAgents_HuntingQueries",
    "_OracleWebLogicUncommonUserAgents_HuntingQueries": "[variables('OracleWebLogicUncommonUserAgents_HuntingQueries')]",
    "OracleWebLogicUrlClienterrors_HuntingQueries": "OracleWebLogicUrlClienterrors_HuntingQueries",
    "_OracleWebLogicUrlClienterrors_HuntingQueries": "[variables('OracleWebLogicUrlClienterrors_HuntingQueries')]",
    "OracleWebLogicUrlServerErrors_HuntingQueries": "OracleWebLogicUrlServerErrors_HuntingQueries",
    "_OracleWebLogicUrlServerErrors_HuntingQueries": "[variables('OracleWebLogicUrlServerErrors_HuntingQueries')]",
    "connector1-source": "[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.OperationalInsights/workspaces/',parameters('workspace'),'/providers/Microsoft.SecurityInsights/dataConnectors/',parameters('connector1-name'))]",
    "_connector1-source": "[variables('connector1-source')]",
    "OracleWebLogicServerConnector": "OracleWebLogicServerConnector",
    "_OracleWebLogicServerConnector": "[variables('OracleWebLogicServerConnector')]",
    "OracleWebLogicCommandInURI_AnalyticalRules": "OracleWebLogicCommandInURI_AnalyticalRules",
    "_OracleWebLogicCommandInURI_AnalyticalRules": "[variables('OracleWebLogicCommandInURI_AnalyticalRules')]",
    "OracleWebLogicDifferentUAsFromSingleIP_AnalyticalRules": "OracleWebLogicDifferentUAsFromSingleIP_AnalyticalRules",
    "_OracleWebLogicDifferentUAsFromSingleIP_AnalyticalRules": "[variables('OracleWebLogicDifferentUAsFromSingleIP_AnalyticalRules')]",
    "OracleWebLogicExploitCVE-2021-2109_AnalyticalRules": "OracleWebLogicExploitCVE-2021-2109_AnalyticalRules",
    "_OracleWebLogicExploitCVE-2021-2109_AnalyticalRules": "[variables('OracleWebLogicExploitCVE-2021-2109_AnalyticalRules')]",
    "OracleWebLogicKnownMaliciousUserAgents_AnalyticalRules": "OracleWebLogicKnownMaliciousUserAgents_AnalyticalRules",
    "_OracleWebLogicKnownMaliciousUserAgents_AnalyticalRules": "[variables('OracleWebLogicKnownMaliciousUserAgents_AnalyticalRules')]",
    "OracleWebLogicMultipleClientErrorsFromSingleIP_AnalyticalRules": "OracleWebLogicMultipleClientErrorsFromSingleIP_AnalyticalRules",
    "_OracleWebLogicMultipleClientErrorsFromSingleIP_AnalyticalRules": "[variables('OracleWebLogicMultipleClientErrorsFromSingleIP_AnalyticalRules')]",
    "OracleWebLogicMultipleServerErrorsRequestsFromSingleIP_AnalyticalRules": "OracleWebLogicMultipleServerErrorsRequestsFromSingleIP_AnalyticalRules",
    "_OracleWebLogicMultipleServerErrorsRequestsFromSingleIP_AnalyticalRules": "[variables('OracleWebLogicMultipleServerErrorsRequestsFromSingleIP_AnalyticalRules')]",
    "OracleWebLogicPrivateIpInUrl_AnalyticalRules": "OracleWebLogicPrivateIpInUrl_AnalyticalRules",
    "_OracleWebLogicPrivateIpInUrl_AnalyticalRules": "[variables('OracleWebLogicPrivateIpInUrl_AnalyticalRules')]",
    "OracleWebLogicPutAndGetFileFromSameIP_AnalyticalRules": "OracleWebLogicPutAndGetFileFromSameIP_AnalyticalRules",
    "_OracleWebLogicPutAndGetFileFromSameIP_AnalyticalRules": "[variables('OracleWebLogicPutAndGetFileFromSameIP_AnalyticalRules')]",
    "OracleWebLogicPutSuspiciousFiles_AnalyticalRules": "OracleWebLogicPutSuspiciousFiles_AnalyticalRules",
    "_OracleWebLogicPutSuspiciousFiles_AnalyticalRules": "[variables('OracleWebLogicPutSuspiciousFiles_AnalyticalRules')]",
    "OracleWebLogicRequestToSensitiveFiles_AnalyticalRules": "OracleWebLogicRequestToSensitiveFiles_AnalyticalRules",
    "_OracleWebLogicRequestToSensitiveFiles_AnalyticalRules": "[variables('OracleWebLogicRequestToSensitiveFiles_AnalyticalRules')]",
    "sourceId": "azuresentinel.azure-sentinel-solution-oracleweblogicserver",
    "_sourceId": "[variables('sourceId')]"
  },
  "resources": [
    {
      "type": "Microsoft.Insights/workbooks",
      "name": "[parameters('workbook1-id')]",
      "location": "[parameters('workspace-location')]",
      "kind": "shared",
      "apiVersion": "2020-02-12",
      "properties": {
        "displayName": "[concat(parameters('workbook1-name'), ' - ', parameters('formattedTimeNow'))]",
        "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"**NOTE**: This data connector depends on a parser based on Kusto Function **OracleWebLogicServerEvent** to work as expected. [Follow steps to get this Kusto Function](https://aka.ms/sentinel-OracleWebLogicServer-parser) \"},\"name\":\"text - 8\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"cd8447d9-b096-4673-92d8-2a1e8291a125\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"description\":\"Sets the time name for analysis\",\"value\":{\"durationMs\":7776000000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":900000},{\"durationMs\":3600000},{\"durationMs\":86400000},{\"durationMs\":604800000},{\"durationMs\":2592000000},{\"durationMs\":7776000000}]},\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 11\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"OracleWebLogicServerEvent\\r\\n| make-series TotalEvents = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain}\",\"size\":0,\"title\":\"Events Over Time\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\",\"graphSettings\":{\"type\":0}},\"customWidth\":\"60\",\"name\":\"query - 12\",\"styleSettings\":{\"maxWidth\":\"55\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//Total Http status code  result\\r\\nOracleWebLogicServerEvent\\r\\n| where isnotempty( HttpStatusCode)\\r\\n| extend HttpStatus = case(\\r\\n    HttpStatusCode startswith \\\"1\\\", \\\"Informational\\\", \\r\\n    HttpStatusCode startswith \\\"2\\\", \\\"Success\\\", \\r\\n    HttpStatusCode startswith \\\"3\\\", \\\"Redirect\\\",\\r\\n    HttpStatusCode startswith \\\"4\\\", \\\"Client Error\\\",\\r\\n    HttpStatusCode startswith \\\"5\\\", \\\"Server Error\\\",\\r\\n    \\\"Unknown\\\")\\r\\n| summarize TotalHttpStatus = count() by HttpStatus\",\"size\":3,\"title\":\"HTTP Status Codes\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"30\",\"name\":\"query - 0\",\"styleSettings\":{\"maxWidth\":\"30\"}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"TomcatEvent\\r\\n| where isnotempty( SrcIpAddr)\\r\\n| summarize dcount(SrcIpAddr) \",\"size\":3,\"title\":\"Unique IP Addresses\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"card\",\"textSettings\":{\"style\":\"bignumber\"}},\"name\":\"query - 0\"}]},\"name\":\"group - 1\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"TomcatEvent\\r\\n| where HttpStatusCode >= 500 and HttpStatusCode <= 599 \\r\\n| count\",\"size\":3,\"title\":\"Total Server Errors\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"card\",\"textSettings\":{\"style\":\"bignumber\"}},\"name\":\"query - 0\"}]},\"name\":\"group - 2\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"TomcatEvent\\r\\n| where HttpStatusCode >= 400 and HttpStatusCode <= 499 \\r\\n| count\",\"size\":3,\"title\":\"Total Client Errors\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"card\",\"textSettings\":{\"style\":\"bignumber\"}},\"name\":\"query - 0\"}]},\"name\":\"group - 2\"}]},\"customWidth\":\"10\",\"name\":\"group - 9\",\"styleSettings\":{\"maxWidth\":\"100\",\"showBorder\":true}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//Top IP requested\\r\\nOracleWebLogicServerEvent\\r\\n| summarize TotalRequests = count() by SrcIpAddr\\r\\n| project-rename SourceIP=SrcIpAddr\\r\\n| top 10 by TotalRequests desc \",\"size\":3,\"title\":\"Top 10 Sources\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"25\",\"name\":\"query - 1\",\"styleSettings\":{\"maxWidth\":\"25\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"OracleWebLogicServerEvent\\r\\n| where isnotempty(EventSeverity)\\r\\n| summarize Severity = count() by EventSeverity\",\"size\":3,\"title\":\"Event Severity\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"25\",\"name\":\"query - 12\",\"styleSettings\":{\"maxWidth\":\"25\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//Top IP requested with server error\\r\\nOracleWebLogicServerEvent\\r\\n| where tolong(HttpStatusCode) >= 500 and tolong(HttpStatusCode) <600\\r\\n| summarize TotalEvents = count() by SrcIpAddr\\r\\n| project-rename SourceIP = SrcIpAddr\\r\\n| top 10 by TotalEvents desc \",\"size\":3,\"title\":\"Top Source IP addresses with server error\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"25\",\"name\":\"query - 3\",\"styleSettings\":{\"margin\":\"10\",\"padding\":\"10\",\"maxWidth\":\"25\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//Top IP requested with client error\\r\\nOracleWebLogicServerEvent\\r\\n| where tolong(HttpStatusCode) >= 400 and tolong(HttpStatusCode) <500\\r\\n| summarize TotalEvents = count() by SrcIpAddr\\r\\n| project-rename SourceIP = SrcIpAddr\\r\\n| top 10 by SourceIP desc \",\"size\":3,\"title\":\"Top Source IP addresses with client error\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"gridSettings\":{\"sortBy\":[{\"itemKey\":\"TotalEvents\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"TotalEvents\",\"sortOrder\":2}]},\"customWidth\":\"25\",\"name\":\"query - 2\",\"styleSettings\":{\"maxWidth\":\"25\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"//Top file requested\\r\\nOracleWebLogicServerEvent\\r\\n| extend File = extract(@\\\".*\\\\/([a-zA-Z0-9-._]*)\\\", 1, tostring(UrlOriginal))\\r\\n| where isnotempty(File)\\r\\n| summarize TotalEvents = count() by File\\r\\n| top 10 by TotalEvents desc\",\"size\":3,\"title\":\"Top files requested\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"name\":\"query - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"OracleWebLogicServerEvent\\r\\n| extend File = extract(@\\\".*\\\\/([a-zA-Z0-9-._]*)\\\", 1, tostring(UrlOriginal))\\r\\n| where isnotempty(File)\\r\\n| sort by TimeGenerated desc \\r\\n| project File, strcat(iff(HttpStatusCode startswith \\\"4\\\" or HttpStatusCode startswith \\\"5\\\", '❌', '✅')), HttpStatusCode, HttpRequestMethod\\r\\n| project-rename Result = Column1, FileName=File\",\"size\":0,\"title\":\"Latest files accessed\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"rowLimit\":50,\"filter\":true}},\"customWidth\":\"35\",\"name\":\"query - 12\",\"styleSettings\":{\"maxWidth\":\"33\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"OracleWebLogicServerEvent\\r\\n| where  TimeGenerated > ago(40d)\\r\\n| where tolong(HttpStatusCode) >= 400 and tolong(HttpStatusCode) <= 599 \\r\\n| where UrlOriginal != '/'\\r\\n| summarize TotalEvents = count() by tostring(UrlOriginal)\\r\\n| top 10 by TotalEvents desc \",\"size\":3,\"title\":\"Top URLs with Error\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\"},\"customWidth\":\"35\",\"name\":\"query - 10\",\"styleSettings\":{\"maxWidth\":\"100\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let Average_Body_Bytes = OracleWebLogicServerEvent\\r\\n| summarize Avg_ByUrl = avg(tolong(HttpResponseBodyBytes))\\r\\n| extend K = 1;\\r\\nOracleWebLogicServerEvent\\r\\n| extend K = 1\\r\\n| join kind=inner Average_Body_Bytes on K\\r\\n| where tolong(HttpResponseBodyBytes) > Avg_ByUrl*1.5\\r\\n| order by tolong(HttpResponseBodyBytes)\\r\\n| summarize RequestSize=max(tolong(HttpResponseBodyBytes)) by SrcIpAddr\\r\\n| project-rename SourceIP=SrcIpAddr\\r\\n\",\"size\":3,\"title\":\"Top sources with large request size\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\",\"gridSettings\":{\"rowLimit\":10},\"graphSettings\":{\"type\":0,\"topContent\":{\"columnMatch\":\"SrcIpAddr\",\"formatter\":1},\"centerContent\":{\"columnMatch\":\"LargeRequest\",\"formatter\":1,\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}},\"chartSettings\":{\"showMetrics\":false,\"showLegend\":true}},\"customWidth\":\"30\",\"name\":\"query - 7\"}],\"fromTemplateId\":\"sentinel-OracleWeblogicServerWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
        "version": "1.0",
        "sourceId": "[variables('_workbook-source')]",
        "category": "sentinel"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2020-08-01",
      "name": "[parameters('workspace')]",
      "location": "[parameters('workspace-location')]",
      "resources": [
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "OracleWebLogicServer Data Parser",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "OracleWebLogicServer Data Parser",
            "category": "Samples",
            "functionAlias": "OracleWebLogicServerEvent",
            "query": "\nlet owl_serverlog =() {\r\nOracleWebLogicServer_CL\r\n| where RawData startswith \"####\"\r\n| extend EventVendor = \"Oracle\"\r\n| extend EventProduct = 'Oracle WebLogic Server'\r\n| extend EventType = 'ServerLog'\r\n| extend EventData = extract_all(@\"<(.*?)>\", RawData)\r\n| extend EventStartTime = todatetime(replace(@',\\d+', @'', replace(@'(\\s\\d{1,2}),', @'\\1', extract(@'\\A(.*(PM|AM))', 1, tostring(EventData[0])))))\r\n| extend DvcTimeZone = extract(@'\\A.*(PM|AM)(.*)', 2, tostring(EventData[0]))\r\n| extend EventSeverity = tostring(EventData[1])\r\n| extend Subsystem = tostring(EventData[2])\r\n| extend DvcHostname = tostring(EventData[3])\r\n| extend SrcDvcHostname = tostring(EventData[4])\r\n| extend TreadId = tostring(EventData[5])\r\n| extend SrcUserName = replace(@'<', '', tostring(EventData[6]))\r\n| extend TransactionId = tostring(EventData[7])\r\n| extend DiagnosticContextId = tostring(EventData[8])\r\n| extend RawTimeValue = tostring(EventData[9])\r\n| extend EventOriginalUid = tostring(EventData[10])\r\n| extend EventMessage = tostring(EventData[11])\r\n};\r\nlet owl_accesslog=() {\r\nOracleWebLogicServer_CL\r\n| where RawData matches regex @'\\A\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}.*\\[.*\\]\\s\\\"(GET|POST)'\r\n| extend EventVendor = \"Oracle\"\r\n| extend EventProduct = 'Oracle WebLogic Server'\r\n| extend EventType = 'AccessLog'\r\n| extend EventData = split(RawData, '\"')\r\n| extend SubEventData0 = split(trim_start(@' ', (trim_end(@' ', tostring(EventData[0])))), ' ')\r\n| extend SubEventData1 = split(EventData[1], ' ')\r\n| extend SubEventData2 = split(trim_start(@' ', (trim_end(@' ', tostring(EventData[2])))), ' ')\r\n| extend SrcIpAddr = tostring(SubEventData0[0])\r\n| extend ClientIdentity = tostring(SubEventData0[1])\r\n| extend SrcUserName = tostring(SubEventData0[2])\r\n| extend EventStartTime = todatetime(replace(@'\\/', @'-', replace(@'(\\d{2}\\/\\w{3}\\/\\d{4}):(\\d{2}\\:\\d{2}\\:\\d{2})', @'\\1 \\2', extract(@'\\[(.*?)(\\-|\\+)\\d+\\]', 1, RawData))))\r\n| extend HttpRequestMethod = tostring(SubEventData1[0])\r\n| extend UrlOriginal = tostring(SubEventData1[1])\r\n| extend HttpVersion = tostring(SubEventData1[2])\r\n| extend HttpStatusCode = tostring(SubEventData2[0])\r\n| extend HttpResponseBodyBytes = tostring(SubEventData2[1])\r\n| extend HttpReferrerOriginal = tostring(EventData[3])\r\n| extend HttpUserAgentOriginal = tostring(EventData[5])\r\n};\r\nunion isfuzzy=true owl_serverlog, owl_accesslog\r\n| project TimeGenerated\r\n        , EventVendor\r\n        , EventProduct\r\n        , EventType\r\n        , EventStartTime\r\n        , DvcTimeZone\r\n        , EventSeverity\r\n        , Subsystem\r\n        , DvcHostname\r\n        , SrcDvcHostname\r\n        , TreadId\r\n        , SrcUserName\r\n        , TransactionId\r\n        , DiagnosticContextId\r\n        , RawTimeValue\r\n        , EventOriginalUid\r\n        , EventMessage\r\n        , SrcIpAddr\r\n        , ClientIdentity\r\n        , HttpRequestMethod\r\n        , UrlOriginal\r\n        , HttpVersion\r\n        , HttpStatusCode\r\n        , HttpResponseBodyBytes\r\n        , HttpReferrerOriginal\r\n        , HttpUserAgentOriginal\r\n",
            "version": 1
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "OracleWebLogicServer Hunting Query 1",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Oracle - Request to forbidden file",
            "category": "Hunting Queries",
            "query": "OracleWebLogicServerEvent\n| where TimeGenerated > ago(24h)\n| where HttpStatusCode == 403\n| extend File = extract(@\"(.*\\/)?(.*)\", 2, tostring(UrlOriginal))\n| extend FileCustomEntity = File\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query shows request to forbidden files."
              },
              {
                "name": "tactics",
                "value": "InitialAccess"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "OracleWebLogicServer Hunting Query 2",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Oracle - Abnormal request size",
            "category": "Hunting Queries",
            "query": "let Average_Body_Bytes = OracleWebLogicServerEvent\n| where TimeGenerated > ago(30d)\n| summarize Avg_Size = avg(tolong(HttpResponseBodyBytes))\n| extend K = 1;\nOracleWebLogicServerEvent\n| where TimeGenerated > ago(24h)\n| extend File = extract(@\"(.*\\/)?(.*)\", 2, tostring(UrlOriginal))\n| extend K = 1\n| join kind=inner Average_Body_Bytes on K\n| where tolong(HttpResponseBodyBytes) > Avg_Size\n| extend FileCustomEntity = File\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query shows abnormal request size."
              },
              {
                "name": "tactics",
                "value": "Exfiltration,Collection"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "OracleWebLogicServer Hunting Query 3",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Oracle - Critical event severity",
            "category": "Hunting Queries",
            "query": "OracleWebLogicServerEvent\n| where TimeGenerated > ago(24h)\n| where isnotempty(EventSeverity)\n| where EventSeverity has_any (\"CRITICAL\", 'ALERT', 'EMERGENCY')\n| extend UrlCustomEntity = UrlOriginal, AccountCustomEntity = SrcUserName\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query shows critical event severity"
              },
              {
                "name": "tactics",
                "value": "InitialAccess"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "OracleWebLogicServer Hunting Query 4",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Oracle - Event message error",
            "category": "Hunting Queries",
            "query": "OracleWebLogicServerEvent\n| where EventMessage has_any (\"error\", \"Invalid\")\n| extend UrlCustomEntity = UrlOriginal\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query shows event message error."
              },
              {
                "name": "tactics",
                "value": "DefenseEvasion"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "OracleWebLogicServer Hunting Query 5",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Oracle - Top files requested by users",
            "category": "Hunting Queries",
            "query": "OracleWebLogicServerEvent\n| where TimeGenerated > ago(24h)\n| where tolong(HttpStatusCode) >= 400 and tolong(HttpStatusCode) <= 599 \n| extend File = extract(@\"(.*\\/)?(.*)\", 2, tostring(UrlOriginal))\n| where isnotempty(File)\n| summarize TotalFile = count() by File\n| top 20 by TotalFile desc\n| extend FileCustomEntity = File\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query shows list of files with error requests."
              },
              {
                "name": "tactics",
                "value": "InitialAccess"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "OracleWebLogicServer Hunting Query 6",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Oracle - Rare user agents with client errors",
            "category": "Hunting Queries",
            "query": "OracleWebLogicServerEvent\n| where TimeGenerated > ago(24h)\n| where tolong(HttpStatusCode) >= 400 and tolong(HttpStatusCode) <= 499\n| where isnotempty(HttpUserAgentOriginal)\n| summarize Total_UA_Count = count() by tostring(HttpUserAgentOriginal)\n| top 20 by Total_UA_Count desc\n| extend UrlCustomEntity = HttpUserAgentOriginal\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query shows rare user agent strings with client errors"
              },
              {
                "name": "tactics",
                "value": "InitialAccess"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "OracleWebLogicServer Hunting Query 7",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Oracle - Rare URLs requested",
            "category": "Hunting Queries",
            "query": "OracleWebLogicServerEvent\n| where TimeGenerated > ago(24h)\n| summarize count() by tostring(UrlOriginal)\n| top 20 by count_ asc\n| extend UrlCustomEntity = UrlOriginal\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query shows rare URLs requested."
              },
              {
                "name": "tactics",
                "value": "InitialAccess"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "OracleWebLogicServer Hunting Query 8",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Oracle - Rare user agents",
            "category": "Hunting Queries",
            "query": "OracleWebLogicServerEvent\n| where TimeGenerated > ago(24h)\n| where isnotempty(HttpUserAgentOriginal)\n| summarize UAs = count() by tostring(HttpUserAgentOriginal)\n| top 20 by UAs asc\n| extend UrlCustomEntity = UAs\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query shows rare user agents"
              },
              {
                "name": "tactics",
                "value": "InitialAccess"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "OracleWebLogicServer Hunting Query 9",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Oracle - Top URLs client errors",
            "category": "Hunting Queries",
            "query": "OracleWebLogicServerEvent\n| where TimeGenerated > ago(24h)\n| where tolong(HttpStatusCode) >= 400 and tolong(HttpStatusCode) <= 499\n| summarize TopUrls = count() by tostring(UrlOriginal)\n| top 20 by TopUrls desc\n| extend UrlCustomEntity = TopUrls\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query shows URLs list with client errors."
              },
              {
                "name": "tactics",
                "value": "Impact,InitialAccess"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "OracleWebLogicServer Hunting Query 10",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Oracle - Top URLs server errors",
            "category": "Hunting Queries",
            "query": "OracleWebLogicServerEvent\n| where TimeGenerated > ago(24h)\n| where tolong(HttpStatusCode) >= 500 and tolong(HttpStatusCode) <= 599\n| summarize TopUrls = count() by tostring(UrlOriginal)\n| top 20 by TopUrls desc\n| extend UrlCustomEntity = TopUrls\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query shows URLs list with server errors."
              },
              {
                "name": "tactics",
                "value": "Impact,InitialAccess"
              }
            ]
          }
        }
      ]
    },
    {
      "id": "[variables('_connector1-source')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('connector1-name'))]",
      "apiVersion": "2021-03-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "location": "[parameters('workspace-location')]",
      "kind": "GenericUI",
      "properties": {
        "connectorUiConfig": {
          "title": "Oracle WebLogic Server",
          "publisher": "Oracle",
          "descriptionMarkdown": "OracleWebLogicServer data connector provides the capability to ingest [OracleWebLogicServer](https://docs.oracle.com/en/middleware/standalone/weblogic-server/index.html) events into Azure Sentinel. Refer to [OracleWebLogicServer documentation](https://docs.oracle.com/en/middleware/standalone/weblogic-server/14.1.1.0/index.html) for more information.",
          "graphQueries": [
            {
              "metricName": "Total data received",
              "legend": "OracleWebLogicServer_CL",
              "baseQuery": "OracleWebLogicServerEvent"
            }
          ],
          "sampleQueries": [
            {
              "description": "Top 10 Devices",
              "query": "OracleWebLogicServerEvent\n | summarize count() by DvcHostname\n | top 10 by count_"
            }
          ],
          "dataTypes": [
            {
              "name": "OracleWebLogicServer_CL",
              "lastDataReceivedQuery": "OracleWebLogicServerEvent\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriterias": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "OracleWebLogicServerEvent\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)"
              ]
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": true
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "read": true,
                  "write": true,
                  "delete": true
                }
              },
              {
                "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                "providerDisplayName": "Keys",
                "scope": "Workspace",
                "requiredPermissions": {
                  "action": true
                }
              }
            ]
          },
          "instructionSteps": [
            {
              "description": ">**NOTE:** This data connector depends on a parser based on a Kusto Function to work as expected. [Follow these steps](https://aka.ms/sentinel-OracleWebLogicServer-parser) to create the Kusto Functions alias, **OracleWebLogicServerEvent**"
            },
            {
              "description": "Install the agent on the Oracle WebLogic Server where the logs are generated.\n\n> Logs from Oracle WebLogic Server deployed on Linux or Windows servers are collected by **Linux** or **Windows** agents.",
              "instructions": [
                {
                  "parameters": {
                    "title": "Choose where to install the Linux agent:",
                    "instructionSteps": [
                      {
                        "title": "Install agent on Azure Linux Virtual Machine",
                        "description": "Select the machine to install the agent on and then click **Connect**.",
                        "instructions": [
                          {
                            "parameters": {
                              "linkType": "InstallAgentOnLinuxVirtualMachine"
                            },
                            "type": "InstallAgent"
                          }
                        ]
                      },
                      {
                        "title": "Install agent on a non-Azure Linux Machine",
                        "description": "Download the agent on the relevant machine and follow the instructions.",
                        "instructions": [
                          {
                            "parameters": {
                              "linkType": "InstallAgentOnLinuxNonAzure"
                            },
                            "type": "InstallAgent"
                          }
                        ]
                      }
                    ]
                  },
                  "type": "InstructionStepsGroup"
                }
              ],
              "title": "1. Install and onboard the agent for Linux or Windows"
            },
            {
              "instructions": [
                {
                  "parameters": {
                    "title": "Choose where to install the Windows agent:",
                    "instructionSteps": [
                      {
                        "title": "Install agent on Azure Windows Virtual Machine",
                        "description": "Select the machine to install the agent on and then click **Connect**.",
                        "instructions": [
                          {
                            "parameters": {
                              "linkType": "InstallAgentOnVirtualMachine"
                            },
                            "type": "InstallAgent"
                          }
                        ]
                      },
                      {
                        "title": "Install agent on a non-Azure Windows Machine",
                        "description": "Download the agent on the relevant machine and follow the instructions.",
                        "instructions": [
                          {
                            "parameters": {
                              "linkType": "InstallAgentOnNonAzure"
                            },
                            "type": "InstallAgent"
                          }
                        ]
                      }
                    ]
                  },
                  "type": "InstructionStepsGroup"
                }
              ]
            },
            {
              "description": "Configure the custom log directory to be collected",
              "instructions": [
                {
                  "parameters": {
                    "linkType": "OpenCustomLogsSettings"
                  },
                  "type": "InstallAgent"
                }
              ],
              "title": "2. Configure the logs to be collected"
            },
            {
              "description": "1. Select the link above to open your workspace advanced settings \n2. From the left pane, select **Data**, select **Custom Logs** and click **Add+**\n3. Click **Browse** to upload a sample of a OracleWebLogicServer log file (e.g. server.log). Then, click **Next >**\n4. Select **New line** as the record delimiter and click **Next >**\n5. Select **Windows** or **Linux** and enter the path to OracleWebLogicServer logs based on your configuration. Example: \n - **Linux** Directory:  'DOMAIN_HOME/servers/server_name/logs/*.log'\n - **Windows** Directory: 'DOMAIN_NAME\\servers\\SERVER_NAME\\logs\\*.log'\n6. After entering the path, click the '+' symbol to apply, then click **Next >** \n7. Add **OracleWebLogicServer_CL** as the custom log Name and click **Done**"
            }
          ],
          "additionalRequirementBanner": "This data connector depends on a parser based on Kusto Function to work as expected. Follow the steps to use this Kusto Function alias **OracleWebLogicServerEvent** in queries and workbooks. [Follow steps to get this Kusto Function>](https://aka.ms/sentinel-OracleWebLogicServer-parser)"
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic1-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects command in URI",
        "displayName": "Oracle - Command in URI",
        "enabled": false,
        "query": "OracleWebLogicServerEvent\n| where UrlOriginal contains 'cat%20/etc/passwd' or UrlOriginal contains '/etc/passwd' or UrlOriginal contains 'ping -i' or UrlOriginal contains '/usr/bin/id(' or UrlOriginal contains '%2f%75%73%72%2f%62%69%6e%2f%69%64' or UrlOriginal contains 'phpinfo()'  or UrlOriginal contains '%70%68%70%69%6e%66%6f%28%29' or UrlOriginal contains ';id' or UrlOriginal contains '%3b%69%64' or UrlOriginal contains '/bin/bash -c' or UrlOriginal contains '%2f%62%69%6e%2f%62%61%73%68%20%2d%63%27' or UrlOriginal contains '/bin/bash' or UrlOriginal contains '%2f%62%69%6e%2f%62%61%73%68' or UrlOriginal contains 'sleep(' or UrlOriginal contains '%73%6c%65%65%70%28' or UrlOriginal  contains 'curl' or UrlOriginal  contains '%63%75%72%6c' or UrlOriginal contains '&dir' or UrlOriginal  contains '%26%64%69%72' or UrlOriginal  contains '& dir' or UrlOriginal =~ '%26%20%64%69%72' or UrlOriginal contains '<script>' or UrlOriginal  contains '%3c%73%63%72%69%70%74%3e' or UrlOriginal contains 'eval(' or UrlOriginal contains '%65%76%61%6c%28' or UrlOriginal contains 'exec(' or UrlOriginal  contains '%65%78%65%63%28'  or UrlOriginal contains 'whoami' or UrlOriginal contains '%77%68%6f%61%6d%69' or UrlOriginal contains 'wget' or UrlOriginal contains 'python' or UrlOriginal contains 'gcc'  or UrlOriginal contains 'uname' or UrlOriginal contains 'systeminfo' or UrlOriginal contains '%77%67%65%74' or UrlOriginal contains '%70%79%74%68%6f%6e' or UrlOriginal contains '%75%6e%61%6d%65' or UrlOriginal  =~ '%73%79%73%74%65%6d%69%6e%66%6f' \n| extend UrlCustomEntity = UrlOriginal\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess"
        ],
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "columnName": "UrlCustomEntity",
                "identifier": "Url"
              }
            ],
            "entityType": "URL"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic2-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects requests with different user agents from one source in short timeframe.",
        "displayName": "Oracle - Multiple user agents for single source",
        "enabled": false,
        "query": "let threshold = 5;\nOracleWebLogicServerEvent\n| summarize makeset(HttpUserAgentOriginal) by SrcIpAddr, bin(TimeGenerated, 5m)\n| extend ua_count = array_length(set_HttpUserAgentOriginal)\n| where ua_count > threshold\n| extend IPCustomEntity = SrcIpAddr\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess"
        ],
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "columnName": "IPCustomEntity",
                "identifier": "Address"
              }
            ],
            "entityType": "IP"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic3-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects using Oracle WebLogic Exploit CVE-2021-2109",
        "displayName": "Oracle - Oracle WebLogic Exploit CVE-2021-2109",
        "enabled": false,
        "query": "OracleWebLogicServerEvent\n| where HttpRequestMethod =~ \"GET\"\n| where UrlOriginal contains \"ldap://\" and UrlOriginal contains \"com.bea.console.handles.JndiBindingHandle\" and UrlOriginal contains \"AdminServer\"\n| extend UrlCustomEntity = UrlOriginal\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess"
        ],
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "columnName": "UrlCustomEntity",
                "identifier": "Url"
              }
            ],
            "entityType": "URL"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic4-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects known malicious user agents",
        "displayName": "Oracle - Known malicious user agent",
        "enabled": false,
        "query": "OracleWebLogicServerEvent\n| where HttpUserAgentOriginal contains 'Nikto' or HttpUserAgentOriginal contains '(hydra)' or HttpUserAgentOriginal contains '.nasl' or HttpUserAgentOriginal contains 'absinthe' or HttpUserAgentOriginal contains 'advanced email extractor' or HttpUserAgentOriginal contains 'arachni/' or HttpUserAgentOriginal contains 'autogetcontent' or HttpUserAgentOriginal contains 'bilbo' or HttpUserAgentOriginal contains 'BFAC' or HttpUserAgentOriginal contains 'brutus' or HttpUserAgentOriginal contains 'brutus/aet' or HttpUserAgentOriginal contains 'bsqlbf' or HttpUserAgentOriginal contains 'cgichk' or HttpUserAgentOriginal contains 'cisco-torch' or HttpUserAgentOriginal contains 'commix' or HttpUserAgentOriginal contains 'core-project/1.0' or HttpUserAgentOriginal contains 'crimscanner/' or HttpUserAgentOriginal contains 'datacha0s' or HttpUserAgentOriginal contains 'dirbuster' or HttpUserAgentOriginal contains 'domino hunter' or HttpUserAgentOriginal contains 'dotdotpwn' or HttpUserAgentOriginal contains 'email extractor' or HttpUserAgentOriginal contains 'fhscan core 1.' or HttpUserAgentOriginal contains 'floodgate' or HttpUserAgentOriginal contains 'get-minimal' or HttpUserAgentOriginal contains 'gootkit auto-rooter scanner' or HttpUserAgentOriginal contains 'grabber' or HttpUserAgentOriginal contains 'grendel-scan' or HttpUserAgentOriginal contains 'havij' or HttpUserAgentOriginal contains 'inspath' or HttpUserAgentOriginal contains 'internet ninja' or HttpUserAgentOriginal contains 'jaascois' or HttpUserAgentOriginal contains 'zmeu'or HttpUserAgentOriginal contains 'masscan' or HttpUserAgentOriginal contains 'metis' or HttpUserAgentOriginal contains 'morfeus' or HttpUserAgentOriginal contains 'mysqloit' or HttpUserAgentOriginal contains 'n-stealth' or HttpUserAgentOriginal contains 'nessus' or HttpUserAgentOriginal contains 'netsparker' or HttpUserAgentOriginal contains 'nmap nse' or HttpUserAgentOriginal contains 'nmap scripting engine' or HttpUserAgentOriginal contains 'nmap-nse' or HttpUserAgentOriginal contains 'nsauditor' or HttpUserAgentOriginal contains 'openvas' or HttpUserAgentOriginal contains 'pangolin' or HttpUserAgentOriginal contains 'paros' or HttpUserAgentOriginal contains 'pmafind' or HttpUserAgentOriginal contains 'prog.customcrawler' or HttpUserAgentOriginal contains 'qualys was' or HttpUserAgentOriginal contains 's.t.a.l.k.e.r.' or HttpUserAgentOriginal contains 'security scan' or HttpUserAgentOriginal contains 'springenwerk' or HttpUserAgentOriginal contains 'sql power injector' or HttpUserAgentOriginal contains 'sqlmap' or HttpUserAgentOriginal contains 'sqlninja' or HttpUserAgentOriginal contains 'teh forest lobster' or HttpUserAgentOriginal contains 'this is an exploit' or HttpUserAgentOriginal contains 'toata dragostea' or HttpUserAgentOriginal contains 'toata dragostea mea pentru diavola' or HttpUserAgentOriginal contains 'uil2pn' or HttpUserAgentOriginal contains 'user-agent:' or HttpUserAgentOriginal contains 'vega/' or HttpUserAgentOriginal contains 'voideye' or HttpUserAgentOriginal contains 'w3af.sf.net' or HttpUserAgentOriginal contains 'w3af.sourceforge.net' or HttpUserAgentOriginal contains 'w3af.org' or HttpUserAgentOriginal contains 'webbandit' or HttpUserAgentOriginal contains 'webinspect' or HttpUserAgentOriginal contains 'webshag' or HttpUserAgentOriginal contains 'webtrends security analyzer' or HttpUserAgentOriginal contains 'webvulnscan' or HttpUserAgentOriginal contains 'whatweb' or HttpUserAgentOriginal contains 'whcc/' or HttpUserAgentOriginal contains 'wordpress hash grabber' or HttpUserAgentOriginal contains 'xmlrpc exploit' or HttpUserAgentOriginal contains 'WPScan' or HttpUserAgentOriginal contains 'XSpider' or HttpUserAgentOriginal contains 'SF/' or HttpUserAgentOriginal contains 'FooBar/42' or HttpUserAgentOriginal contains 'ScanAlert' or HttpUserAgentOriginal contains 'Webscanner' or HttpUserAgentOriginal contains 'Webster' or HttpUserAgentOriginal contains 'fantomCrew' or HttpUserAgentOriginal contains 'fantomBrowser' or HttpUserAgentOriginal contains 'visvo' or HttpUserAgentOriginal contains 'magereport' or HttpUserAgentOriginal contains 'ltx71' or HttpUserAgentOriginal contains 'websiteprotection' or HttpUserAgentOriginal contains 'BigCliqueBOT' or HttpUserAgentOriginal contains '(BOT for JCE)'\n| extend MalwareCustomEntity = HttpUserAgentOriginal\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess"
        ],
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "columnName": "MalwareCustomEntity",
                "identifier": "Name"
              }
            ],
            "entityType": "Malware"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic5-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects multiple client errors from one source in short timeframe",
        "displayName": "Oracle - Multiple client errors from single IP",
        "enabled": false,
        "query": "let threshold = 100;\nOracleWebLogicServerEvent\n| where tolong(HttpStatusCode) >= 400 and tolong(HttpStatusCode) <= 499 \n| summarize MultipleClientErrors = count() by SrcIpAddr, bin(TimeGenerated, 5m)\n| where MultipleClientErrors > threshold\n| extend IPCustomEntity = SrcIpAddr\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess"
        ],
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "columnName": "IPCustomEntity",
                "identifier": "Address"
              }
            ],
            "entityType": "IP"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic6-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects multiple server errors from one source in short timeframe",
        "displayName": "Oracle - Multiple server errors from single IP",
        "enabled": false,
        "query": "let threshold = 100;\nOracleWebLogicServerEvent\n| where tolong(HttpStatusCode) >= 500 and tolong(HttpStatusCode) <= 599 \n| summarize MultipleServerErrors = count() by SrcIpAddr, bin(TimeGenerated, 5m)\n| where MultipleServerErrors > threshold\n| extend IPCustomEntity = SrcIpAddr\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Impact",
          "InitialAccess"
        ],
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "columnName": "IPCustomEntity",
                "identifier": "Address",
                "version": "1.0.0"
              }
            ],
            "entityType": "IP"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic7-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects requests to unusual URL",
        "displayName": "Oracle - Private IP in URL",
        "enabled": false,
        "query": "OracleWebLogicServerEvent\n| where UrlOriginal matches regex @'(10\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3})|(172\\.1[6-9]\\.\\d{1,3}\\.\\d{1,3})|(172\\.2[0-9]\\.\\d{1,3}\\.\\d{1,3})|(172\\.3[0-1]\\.\\d{1,3}\\.\\d{1,3})|(192\\.168\\.\\d{1,3}\\.\\d{1,3})'\n| extend UrlCustomEntity = UrlOriginal\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess"
        ],
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "columnName": "UrlCustomEntity",
                "identifier": "Url"
              }
            ],
            "entityType": "URL"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic8-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects put or get files from one source in short timeframe",
        "displayName": "Oracle - Put file and get file from same IP address",
        "enabled": false,
        "query": "let p = OracleWebLogicServerEvent\n| where HttpRequestMethod in~ ('POST', 'PUT')\n| sort by EventStartTime asc\n| summarize post_time=min(EventStartTime) by SrcIpAddr, tostring(UrlOriginal);\nOracleWebLogicServerEvent\n| where HttpRequestMethod =~ 'GET'\n| sort by EventStartTime asc\n| summarize get_time=min(EventStartTime) by SrcIpAddr, tostring(UrlOriginal)\n| join kind=innerunique (p) on UrlOriginal, SrcIpAddr\n| extend second = datetime_diff('second',get_time,post_time)\n| where second between (1 .. 300)\n| project second, post_time, get_time, SrcIpAddr, UrlOriginal\n| extend IPCustomEntity = SrcIpAddr, UrlCustomEntity = tostring(UrlOriginal)\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess"
        ],
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "columnName": "IPCustomEntity",
                "identifier": "Address"
              }
            ],
            "entityType": "IP"
          },
          {
            "fieldMappings": [
              {
                "columnName": "UrlCustomEntity",
                "identifier": "Url"
              }
            ],
            "entityType": "URL"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic9-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects PUT or POST of suspicious file",
        "displayName": "Oracle - Put suspicious file",
        "enabled": false,
        "query": "OracleWebLogicServerEvent\n| where HttpRequestMethod in~ (\"POST\", \"PUT\") \n| extend File = extract(@\"(.*\\/)?(.*)\", 2, tostring(UrlOriginal))\n| where isnotempty(File)\n| where File matches regex @\"([a-zA-Z0-9-_]+\\.)([a-zA-Z0-9-]+\\.[a-zA-Z0-9-]+)\"\n| extend FileCustomEntity = File, UrlCustomEntity = UrlOriginal\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess",
          "Exfiltration"
        ],
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "columnName": "FileCustomEntity",
                "identifier": "Name"
              }
            ],
            "entityType": "File"
          },
          {
            "fieldMappings": [
              {
                "columnName": "UrlCustomEntity",
                "identifier": "Url"
              }
            ],
            "entityType": "URL"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic10-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects request to sensitive files.",
        "displayName": "Oracle - Request to sensitive files",
        "enabled": false,
        "query": "let forbidden_files = dynamic(['shadow', 'passwd', 'hosts']);\nOracleWebLogicServerEvent    \n| extend File = extract(@'(.*\\/)?(.*)', 2, tostring(UrlOriginal))\n| where File in (forbidden_files)\n| extend FileCustomEntity = File, UrlCustomEntity = UrlOriginal\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess"
        ],
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "columnName": "FileCustomEntity",
                "identifier": "Name"
              }
            ],
            "entityType": "File"
          },
          {
            "fieldMappings": [
              {
                "columnName": "UrlCustomEntity",
                "identifier": "Url"
              }
            ],
            "entityType": "URL"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "version": "1.0.1",
        "kind": "Solution",
        "contentId": "[variables('_sourceId')]",
        "parentId": "[variables('_sourceId')]",
        "source": {
          "kind": "Solution",
          "name": "OracleWebLogicServer",
          "sourceId": "[variables('_sourceId')]"
        },
        "author": {
          "name": "Manoj Arimanda",
          "email": "v-marimanda@microsoft.com"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "Workbook",
              "contentId": "[variables('_OracleWorkbook_workbook')]",
              "version": "1.0.1"
            },
            {
              "kind": "Parser",
              "contentId": "[variables('_OracleWebLogicServerEvent_Parser')]",
              "version": "1.0.1"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_OracleWebLogic403RequestsFiles_HuntingQueries')]",
              "version": "1.0.1"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_OracleWebLogicAbnormalRequestSize_HuntingQueries')]",
              "version": "1.0.1"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_OracleWebLogicCriticalEventSeverity_HuntingQueries')]",
              "version": "1.0.1"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_OracleWebLogicErrors_HuntingQueries')]",
              "version": "1.0.1"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_OracleWebLogicFilesErrorRequests_HuntingQueries')]",
              "version": "1.0.1"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_OracleWebLogicRareUAWithClientErrors_HuntingQueries')]",
              "version": "1.0.1"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_OracleWebLogicRareURLsRequested_HuntingQueries')]",
              "version": "1.0.1"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_OracleWebLogicUncommonUserAgents_HuntingQueries')]",
              "version": "1.0.1"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_OracleWebLogicUrlClienterrors_HuntingQueries')]",
              "version": "1.0.1"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_OracleWebLogicUrlServerErrors_HuntingQueries')]",
              "version": "1.0.1"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_OracleWebLogicServerConnector')]",
              "version": "1.0.1"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_OracleWebLogicCommandInURI_AnalyticalRules')]",
              "version": "1.0.1"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_OracleWebLogicDifferentUAsFromSingleIP_AnalyticalRules')]",
              "version": "1.0.1"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_OracleWebLogicExploitCVE-2021-2109_AnalyticalRules')]",
              "version": "1.0.1"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_OracleWebLogicKnownMaliciousUserAgents_AnalyticalRules')]",
              "version": "1.0.1"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_OracleWebLogicMultipleClientErrorsFromSingleIP_AnalyticalRules')]",
              "version": "1.0.1"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_OracleWebLogicMultipleServerErrorsRequestsFromSingleIP_AnalyticalRules')]",
              "version": "1.0.1"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_OracleWebLogicPrivateIpInUrl_AnalyticalRules')]",
              "version": "1.0.1"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_OracleWebLogicPutAndGetFileFromSameIP_AnalyticalRules')]",
              "version": "1.0.1"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_OracleWebLogicPutSuspiciousFiles_AnalyticalRules')]",
              "version": "1.0.1"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_OracleWebLogicRequestToSensitiveFiles_AnalyticalRules')]",
              "version": "1.0.1"
            }
          ]
        },
        "firstPublishDate": "2022-01-06",
        "providers": [
          "Oracle"
        ],
        "categories": {
          "domains": [
            "IT operations"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_sourceId'))]"
    }
  ],
  "outputs": {}
}
