{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Eli Forbes - v-eliforbes@microsoft.com",
    "comments": "Solution template for SlackAudit"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Sentinel is setup"
      }
    },
    "formattedTimeNow": {
      "type": "string",
      "defaultValue": "[utcNow('g')]",
      "metadata": {
        "description": "Appended to workbook displayNames to make them unique"
      }
    },
    "workbook1-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the workbook"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "SlackAudit",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    },
    "analytic1-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic2-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic3-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic4-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic5-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic6-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic7-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic8-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic9-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "connector1-name": {
      "type": "string",
      "defaultValue": "af4c54c8-84e6-45a8-9566-d7171f02193f"
    },
    "connector2-name": {
      "type": "string",
      "defaultValue": "549ac275-2a8d-4685-8d3e-31fabc3c7c43"
    }
  },
  "variables": {
    "SlackAudit_workbook": "SlackAudit_workbook",
    "_SlackAudit_workbook": "[variables('SlackAudit_workbook')]",
    "workbook-source": "[concat(resourceGroup().id, '/providers/Microsoft.OperationalInsights/workspaces/',parameters('workspace'))]",
    "_workbook-source": "[variables('workbook-source')]",
    "SlackAuditEmptyUA_AnalyticalRules": "SlackAuditEmptyUA_AnalyticalRules",
    "_SlackAuditEmptyUA_AnalyticalRules": "[variables('SlackAuditEmptyUA_AnalyticalRules')]",
    "SlackAuditMultipleArchivedFilesUploadedInShortTimePeriod_AnalyticalRules": "SlackAuditMultipleArchivedFilesUploadedInShortTimePeriod_AnalyticalRules",
    "_SlackAuditMultipleArchivedFilesUploadedInShortTimePeriod_AnalyticalRules": "[variables('SlackAuditMultipleArchivedFilesUploadedInShortTimePeriod_AnalyticalRules')]",
    "SlackAuditMultipleFailedLoginsForUser_AnalyticalRules": "SlackAuditMultipleFailedLoginsForUser_AnalyticalRules",
    "_SlackAuditMultipleFailedLoginsForUser_AnalyticalRules": "[variables('SlackAuditMultipleFailedLoginsForUser_AnalyticalRules')]",
    "SlackAuditSensitiveFile_AnalyticalRules": "SlackAuditSensitiveFile_AnalyticalRules",
    "_SlackAuditSensitiveFile_AnalyticalRules": "[variables('SlackAuditSensitiveFile_AnalyticalRules')]",
    "SlackAuditSuspiciousFileDownloaded_AnalyticalRules": "SlackAuditSuspiciousFileDownloaded_AnalyticalRules",
    "_SlackAuditSuspiciousFileDownloaded_AnalyticalRules": "[variables('SlackAuditSuspiciousFileDownloaded_AnalyticalRules')]",
    "SlackAuditUnknownUA_AnalyticalRules": "SlackAuditUnknownUA_AnalyticalRules",
    "_SlackAuditUnknownUA_AnalyticalRules": "[variables('SlackAuditUnknownUA_AnalyticalRules')]",
    "SlackAuditUserChangedToAdminOrOwner_AnalyticalRules": "SlackAuditUserChangedToAdminOrOwner_AnalyticalRules",
    "_SlackAuditUserChangedToAdminOrOwner_AnalyticalRules": "[variables('SlackAuditUserChangedToAdminOrOwner_AnalyticalRules')]",
    "SlackAuditUserEmailChanged_AnalyticalRules": "SlackAuditUserEmailChanged_AnalyticalRules",
    "_SlackAuditUserEmailChanged_AnalyticalRules": "[variables('SlackAuditUserEmailChanged_AnalyticalRules')]",
    "SlackAuditUserLoginAfterDeactivated_AnalyticalRules": "SlackAuditUserLoginAfterDeactivated_AnalyticalRules",
    "_SlackAuditUserLoginAfterDeactivated_AnalyticalRules": "[variables('SlackAuditUserLoginAfterDeactivated_AnalyticalRules')]",
    "connector1-source": "[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.OperationalInsights/workspaces/',parameters('workspace'),'/providers/Microsoft.SecurityInsights/dataConnectors/',parameters('connector1-name'))]",
    "_connector1-source": "[variables('connector1-source')]",
    "SlackAuditAPIConnector": "SlackAuditAPIConnector",
    "_SlackAuditAPIConnector": "[variables('SlackAuditAPIConnector')]",
    "connector2-source": "[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.OperationalInsights/workspaces/',parameters('workspace'),'/providers/Microsoft.SecurityInsights/dataConnectors/',parameters('connector2-name'))]",
    "_connector2-source": "[variables('connector2-source')]",
    "Connector": "SlackAuditNativePollerConnector",
    "_Connector": "[variables('Connector')]",
    "workspace-dependency": "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspace'))]",
    "SlackAudit_Parser": "SlackAudit_Parser",
    "_SlackAudit_Parser": "[variables('SlackAudit_Parser')]",
    "SlackAuditApplicationsInstalled_HuntingQueries": "SlackAuditApplicationsInstalled_HuntingQueries",
    "_SlackAuditApplicationsInstalled_HuntingQueries": "[variables('SlackAuditApplicationsInstalled_HuntingQueries')]",
    "SlackAuditDeactivatedUsers_HuntingQueries": "SlackAuditDeactivatedUsers_HuntingQueries",
    "_SlackAuditDeactivatedUsers_HuntingQueries": "[variables('SlackAuditDeactivatedUsers_HuntingQueries')]",
    "SlackAuditDownloadedFilesByUser_HuntingQueries": "SlackAuditDownloadedFilesByUser_HuntingQueries",
    "_SlackAuditDownloadedFilesByUser_HuntingQueries": "[variables('SlackAuditDownloadedFilesByUser_HuntingQueries')]",
    "SlackAuditFailedLoginsUnknownUsername_HuntingQueries": "SlackAuditFailedLoginsUnknownUsername_HuntingQueries",
    "_SlackAuditFailedLoginsUnknownUsername_HuntingQueries": "[variables('SlackAuditFailedLoginsUnknownUsername_HuntingQueries')]",
    "SlackAuditNewUsers_HuntingQueries": "SlackAuditNewUsers_HuntingQueries",
    "_SlackAuditNewUsers_HuntingQueries": "[variables('SlackAuditNewUsers_HuntingQueries')]",
    "SlackAuditSuspiciousFilesDownloaded_HuntingQueries": "SlackAuditSuspiciousFilesDownloaded_HuntingQueries",
    "_SlackAuditSuspiciousFilesDownloaded_HuntingQueries": "[variables('SlackAuditSuspiciousFilesDownloaded_HuntingQueries')]",
    "SlackAuditUploadedFilesByUser_HuntingQueries": "SlackAuditUploadedFilesByUser_HuntingQueries",
    "_SlackAuditUploadedFilesByUser_HuntingQueries": "[variables('SlackAuditUploadedFilesByUser_HuntingQueries')]",
    "SlackAuditUserLoginsByIP_HuntingQueries": "SlackAuditUserLoginsByIP_HuntingQueries",
    "_SlackAuditUserLoginsByIP_HuntingQueries": "[variables('SlackAuditUserLoginsByIP_HuntingQueries')]",
    "SlackAuditUserPermissionsChanged_HuntingQueries": "SlackAuditUserPermissionsChanged_HuntingQueries",
    "_SlackAuditUserPermissionsChanged_HuntingQueries": "[variables('SlackAuditUserPermissionsChanged_HuntingQueries')]",
    "SlackAuditUsersJoinedChannelsWithoutInvites_HuntingQueries": "SlackAuditUsersJoinedChannelsWithoutInvites_HuntingQueries",
    "_SlackAuditUsersJoinedChannelsWithoutInvites_HuntingQueries": "[variables('SlackAuditUsersJoinedChannelsWithoutInvites_HuntingQueries')]",
    "sourceId": "azuresentinel.azure-sentinel-solution-slackaudit",
    "_sourceId": "[variables('sourceId')]"
  },
  "resources": [
    {
      "type": "Microsoft.Insights/workbooks",
      "name": "[parameters('workbook1-id')]",
      "location": "[parameters('workspace-location')]",
      "kind": "shared",
      "apiVersion": "2020-02-12",
      "properties": {
        "displayName": "[concat(parameters('workbook1-name'), ' - ', parameters('formattedTimeNow'))]",
        "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\">**NOTE:** This workbook uses a parser based on a Kusto Function to normalize fields. [Follow these steps](https://aka.ms/sentinel-SlackAuditAPI-parser) to create the Kusto function alias **SlackAudit**.\"},\"name\":\"text - 0\"},{\"type\":11,\"content\":{\"version\":\"LinkItem/1.0\",\"style\":\"tabs\",\"links\":[{\"id\":\"e34269c3-8c77-4e2c-aacb-b86537b2fa1d\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Slack User Activity\",\"subTarget\":\"slack_user_activity\",\"preText\":\"Slack User Activity\",\"style\":\"link\"},{\"id\":\"6d5f697d-6098-4196-bba8-843fefeeb2de\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Slack App Activity\",\"subTarget\":\"slack_app_activity\",\"style\":\"link\"},{\"id\":\"0be65784-c532-422e-9086-58b4de769e34\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Slack File Activity\",\"subTarget\":\"slack_file_activity\",\"style\":\"link\"},{\"id\":\"3ea7ee87-1041-4002-8169-8491ff5d0435\",\"cellValue\":\"Tab\",\"linkTarget\":\"parameter\",\"linkLabel\":\"Slack Channels Activity\",\"subTarget\":\"slack_channels_activity\",\"style\":\"link\"}]},\"name\":\"links - 10\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"6b5965ee-e865-485e-b361-22f71c9ae4f1\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"isRequired\":true,\"value\":{\"durationMs\":2419200000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":300000},{\"durationMs\":900000},{\"durationMs\":1800000},{\"durationMs\":3600000},{\"durationMs\":14400000},{\"durationMs\":43200000},{\"durationMs\":86400000},{\"durationMs\":172800000},{\"durationMs\":259200000},{\"durationMs\":604800000},{\"durationMs\":1209600000},{\"durationMs\":2419200000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}]},\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SlackAudit \\n| extend evt_time = unixtime_seconds_todatetime(EventEndTime)\\n| where evt_time {TimeRange}\\n | where Action startswith \\\"user\\\" | summarize count() by Action\",\"size\":3,\"title\":\"Users Action Chart\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"slack_user_activity\"},\"customWidth\":\"33\",\"name\":\"Users Action Chart\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SlackAudit | extend evt_time = unixtime_seconds_todatetime(EventEndTime)\\n| where evt_time {TimeRange}\\n| where Action == \\\"user_login\\\"\\n|make-series Trend = count(SrcUserEmail) on evt_time from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by SrcUserEmail;\",\"size\":0,\"title\":\"Successful Logins over Time\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\",\"tileSettings\":{\"showBorder\":false}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"slack_user_activity\"},\"customWidth\":\"33\",\"name\":\"Successful Logins over Time\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SlackAudit | extend evt_time = unixtime_seconds_todatetime(EventEndTime)\\n| where evt_time {TimeRange}\\n| where Action == \\\"user_login_failed\\\"\\n|make-series Trend = count(SrcUserEmail) on evt_time from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by SrcUserEmail;\",\"size\":3,\"title\":\"Failed Logins over Time\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\",\"tileSettings\":{\"showBorder\":false}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"slack_user_activity\"},\"customWidth\":\"33\",\"name\":\"Failed Logins over Time\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SlackAudit | extend evt_time = unixtime_seconds_todatetime(EventEndTime)\\n| where evt_time {TimeRange}\\n| where Action == \\\"user_login\\\"\\n| summarize Login = count() by Time=evt_time, Email=ActorUserEmail, Context_Domain_Location=ContextLocationDomain, IP=ContextIpAddress, ContextLocationName = ContextLocationName | sort by Time \",\"size\":3,\"title\":\"Login Activity\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"rowLimit\":20}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"slack_user_activity\"},\"customWidth\":\"50\",\"name\":\"Login Activity\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SlackAudit | extend evt_time = unixtime_seconds_todatetime(EventEndTime)\\n| where evt_time {TimeRange}\\n| where Action == \\\"user_created\\\"\\n| project Time=evt_time, Email=ActorUserEmail, Context_Domain_Location=ContextLocationDomain, IP=ContextIpAddress, ContextLocationName = ContextLocationName,Created_User=EntityUserEmail, Action, ActionDescription | sort by Time\",\"size\":3,\"title\":\"Users Created\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"rowLimit\":20}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"slack_user_activity\"},\"customWidth\":\"50\",\"name\":\"Users Created\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let Guest_Created_list = \\nSlackAudit | extend evt_time = unixtime_seconds_todatetime(EventEndTime)\\n| where evt_time {TimeRange}\\n| where Action == \\\"guest_created\\\" | summarize make_list(EntityUserEmail);\\nlet Guest_Actions =\\n SlackAudit | extend evt_time = unixtime_seconds_todatetime(EventEndTime)\\n | where evt_time {TimeRange}\\n | where ActorUserEmail in (Guest_Created_list)\\n | extend UserAct = strcat(ActorUserEmail,\\\" - \\\",Action);\\n Guest_Actions | make-series Trend = count() on evt_time from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by UserAct\",\"size\":0,\"title\":\"New Guest Users Activity Timechart\",\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\",\"graphSettings\":{\"type\":0},\"mapSettings\":{\"locInfo\":\"LatLong\"}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"slack_user_activity\"},\"customWidth\":\"50\",\"name\":\"New Guest Users Activity Timechart\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SlackAudit | extend evt_time = unixtime_seconds_todatetime(EventEndTime)\\n| where evt_time {TimeRange}\\n| where Action == \\\"user_deactivated\\\"\\n| project Time=evt_time, Email=ActorUserEmail, Context_Domain_Location=ContextLocationDomain, IP=ContextIpAddress, ContextLocationName = ContextLocationName,Deactivated_User=EntityUserEmail, Action, ActionDescription | sort by Time\",\"size\":0,\"title\":\"Users Deactivated\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"slack_user_activity\"},\"customWidth\":\"50\",\"name\":\"Users Deactivated\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let Guest_Created_list = \\nSlackAudit | extend evt_time = unixtime_seconds_todatetime(EventEndTime)\\n| where evt_time {TimeRange}\\n| where Action == \\\"guest_created\\\" | summarize make_list(EntityUserEmail);\\nlet Guest_Actions =\\n SlackAudit | extend evt_time = unixtime_seconds_todatetime(EventEndTime)\\n | where evt_time {TimeRange}\\n| where ActorUserEmail in (Guest_Created_list);\\n Guest_Actions | project Time=evt_time, GuestEmail=ActorUserEmail, Context_Domain_Location=ContextLocationDomain, IP=ContextIpAddress, ContextLocationName = ContextLocationName, Action, ActionDescription | sort by Time\",\"size\":0,\"title\":\"New Guest Users Activity \",\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"slack_user_activity\"},\"customWidth\":\"50\",\"name\":\"New Guest Users Activity \"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\" SlackAudit\\n | extend evt_time = unixtime_seconds_todatetime(EventEndTime)\\n | where evt_time {TimeRange}\\n | where Action == \\\"app_installed\\\" or Action == \\\"app_approved\\\" or Action == \\\"app_restricted\\\"\\n | extend Action = case(Action == \\\"app_installed\\\", \\\"Applications Installed\\\", \\n                       Action == \\\"app_approved\\\", \\\"Applications Approved\\\", \\n                       \\\"Applications Restricted\\\")\\n | summarize count() by Action\",\"size\":1,\"title\":\"Application Actions\",\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"Action\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"slack_app_activity\"},\"customWidth\":\"100\",\"name\":\"Application Actions\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SlackAudit\\n | extend evt_time = unixtime_seconds_todatetime(EventEndTime)\\n | where evt_time {TimeRange}\\n | where Action == \\\"app_installed\\\"\\n |  project Time=evt_time, ActorUserEmail, Context_Domain_Location=ContextLocationDomain, IP=ContextIpAddress, ContextLocationName = ContextLocationName, Action, ActionDescription, AppScopes =EntityAppScopes, App=EntityAppName \\n | summarize Count=count() by App | sort by Count desc\",\"size\":0,\"title\":\"Apps Installed Chart\",\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"slack_app_activity\"},\"customWidth\":\"50\",\"name\":\"Apps Installed Chart\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\" SlackAudit\\n | extend evt_time = unixtime_seconds_todatetime(EventEndTime)\\n | where evt_time {TimeRange}\\n | where Action == \\\"app_installed\\\"\\n |  project Time=evt_time, ActorUserEmail, Context_Domain_Location=ContextLocationDomain, IP=ContextIpAddress, ContextLocationName = ContextLocationName, Action, ActionDescription, AppScopes =EntityAppScopes, App=EntityAppName | sort by Time\",\"size\":0,\"title\":\"Apps Installed\",\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"slack_app_activity\"},\"customWidth\":\"50\",\"name\":\"Apps Installed\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\" SlackAudit\\n | extend evt_time = unixtime_seconds_todatetime(EventEndTime)\\n | where evt_time {TimeRange}\\n | where Action == \\\"app_restricted\\\"\\n |  project Time=evt_time, ActorUserEmail, Context_Domain_Location=ContextLocationDomain, IP=ContextIpAddress, ContextLocationName = ContextLocationName, Action, ActionDescription, AppScopes =EntityAppScopes, App=EntityAppName | sort by Time\",\"size\":0,\"title\":\"Apps Restricted\",\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"slack_app_activity\"},\"customWidth\":\"50\",\"name\":\"Apps Restricted\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SlackAudit\\n | extend evt_time = unixtime_seconds_todatetime(EventEndTime)\\n | where evt_time {TimeRange}\\n | where Action == \\\"app_restricted\\\"\\n |  project Time=evt_time, ActorUserEmail, Context_Domain_Location=ContextLocationDomain, IP=ContextIpAddress, ContextLocationName = ContextLocationName, Action, ActionDescription, AppScopes =EntityAppScopes, App=EntityAppName \\n | summarize Count=count() by App | sort by Count desc\",\"size\":0,\"title\":\"Apps Restricted Chart\",\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"slack_app_activity\"},\"customWidth\":\"50\",\"name\":\"Apps Restricted Chart\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\" SlackAudit\\n | extend evt_time = unixtime_seconds_todatetime(EventEndTime)\\n | where evt_time {TimeRange}\\n | where Action == \\\"app_approved\\\"\\n |  project Time=evt_time, ActorUserEmail, Context_Domain_Location=ContextLocationDomain, IP=ContextIpAddress, ContextLocationName = ContextLocationName, Action, ActionDescription, AppScopes =EntityAppScopes, App=EntityAppName | sort by Time\",\"size\":0,\"title\":\"Apps Approved\",\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"slack_app_activity\"},\"customWidth\":\"50\",\"name\":\"Apps Approved\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SlackAudit\\n | extend evt_time = unixtime_seconds_todatetime(EventEndTime)\\n | where evt_time {TimeRange}\\n | where Action == \\\"app_approved\\\"\\n |  project Time=evt_time, ActorUserEmail, Context_Domain_Location=ContextLocationDomain, IP=ContextIpAddress, ContextLocationName = ContextLocationName, Action, ActionDescription, AppScopes =EntityAppScopes, App=EntityAppName \\n | summarize Count=count() by App | sort by Count desc\",\"size\":0,\"title\":\"Apps Approved Chart\",\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"slack_app_activity\"},\"customWidth\":\"50\",\"name\":\"Apps Approved Chart\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\" SlackAudit\\n | extend evt_time = unixtime_seconds_todatetime(EventEndTime)\\n | where evt_time {TimeRange}\\n | where Action == \\\"file_downloaded\\\" or Action == \\\"file_uploaded\\\" or Action == \\\"file_shared\\\" or Action == \\\"file_public_link_created\\\" or Action == \\\"file_public_link_revoked\\\" or Action == \\\"file_downloaded_blocked\\\"\\n | extend Action = case(Action == \\\"file_downloaded\\\", \\\"Downloaded\\\", Action == \\\"file_uploaded\\\", \\\"Uploaded\\\", Action == \\\"file_shared\\\",\\\"Shared\\\", Action == \\\"file_public_link_created\\\", \\\"Public Link Created\\\",Action == \\\"file_public_link_revoked\\\", \\\"Public Link Revoked\\\",\\\"Download Blocked\\\" )\\n | summarize count() by Action | sort by count_ desc\",\"size\":1,\"title\":\"File Actions\",\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"showBorder\":false,\"titleContent\":{\"columnMatch\":\"Action\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}}}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"slack_file_activity\"},\"name\":\"File Actions\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\" SlackAudit\\n | extend evt_time = unixtime_seconds_todatetime(EventEndTime)\\n | where evt_time {TimeRange}\\n | where Action == \\\"file_downloaded\\\"\\n | make-series Trend = count() on evt_time from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by ActorUserEmail;\",\"size\":0,\"title\":\"File Downloads Activity TImechart\",\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"slack_file_activity\"},\"customWidth\":\"50\",\"name\":\"File Downloads Activity TImechart\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\" SlackAudit\\n | extend evt_time = unixtime_seconds_todatetime(EventEndTime)\\n | where evt_time {TimeRange}\\n | where Action == \\\"file_downloaded\\\"\\n | project Time =evt_time, Workspace=ContextLocationName, [\\\"File Title\\\"] = EntityFileTitle, User = ActorUserName, Action, ActionDescription\\n | sort by Time desc | take 100\",\"size\":0,\"title\":\"File Downloads Activity\",\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"slack_file_activity\"},\"customWidth\":\"50\",\"name\":\"File Downloads Activity\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\" SlackAudit\\n | extend evt_time = unixtime_seconds_todatetime(EventEndTime)\\n | where Action == \\\"file_uploaded\\\"\\n | make-series Trend = count() on evt_time from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by ActorUserEmail;\",\"size\":0,\"title\":\"File Uploads Activity Timechart\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"slack_file_activity\"},\"customWidth\":\"50\",\"name\":\"File Uploads Activity Timechart\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\" SlackAudit\\n | extend evt_time = unixtime_seconds_todatetime(EventEndTime)\\n | where evt_time {TimeRange}\\n | where Action == \\\"file_uploaded\\\"\\n | project Time =evt_time, Workspace=ContextLocationName, [\\\"File Title\\\"] = EntityFileTitle, User = ActorUserName, Action, ActionDescription\\n | sort by Time desc | take 100\",\"size\":0,\"title\":\"File Uploads Activity\",\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"slack_file_activity\"},\"customWidth\":\"50\",\"name\":\"File Uploads Activity\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\" SlackAudit\\n | extend evt_time = unixtime_seconds_todatetime(EventEndTime)\\n | where evt_time {TimeRange}\\n | where Action == \\\"file_shared\\\"\\n | make-series Trend = count() on evt_time from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by ActorUserEmail;\",\"size\":0,\"title\":\"Shared Files Activity Timechart\",\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"slack_file_activity\"},\"customWidth\":\"50\",\"name\":\"Shared Files Activity Timechart\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\" SlackAudit\\n | extend evt_time = unixtime_seconds_todatetime(EventEndTime)\\n | where evt_time {TimeRange}\\n | where Action == \\\"file_shared\\\"\\n | project Time =evt_time, Workspace=ContextLocationName, [\\\"File Title\\\"] = EntityFileTitle, User = ActorUserName, Action, ActionDescription\\n | sort by Time desc | take 100\",\"size\":0,\"title\":\"Shared Files Activity\",\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"slack_file_activity\"},\"customWidth\":\"50\",\"name\":\"Shared Files Activity\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\" SlackAudit\\n | extend evt_time = unixtime_seconds_todatetime(EventEndTime)\\n | where evt_time {TimeRange}\\n | where Action == \\\"file_public_link_created\\\"\\n | make-series Trend = count() on evt_time from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by ActorUserEmail;\",\"size\":0,\"title\":\"File Public Link Created Activity Timechart\",\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"slack_file_activity\"},\"customWidth\":\"50\",\"name\":\"File Public Link Created Activity Timechart\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\" SlackAudit\\n | extend evt_time = unixtime_seconds_todatetime(EventEndTime)\\n | where evt_time {TimeRange}\\n | where Action == \\\"file_public_link_created\\\"\\n | project Time =evt_time, Workspace=ContextLocationName, [\\\"File Title\\\"] = EntityFileTitle, User = ActorUserName, Action, ActionDescription\\n | sort by Time desc | take 100\",\"size\":0,\"title\":\"File Public Link Created Activity\",\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"slack_file_activity\"},\"customWidth\":\"50\",\"name\":\"File Public Link Created Activity\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\" SlackAudit\\n | extend evt_time = unixtime_seconds_todatetime(EventEndTime)\\n | where evt_time {TimeRange}\\n | where Action == \\\"file_public_link_revoked\\\"\\n | make-series Trend = count() on evt_time from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by ActorUserEmail;\",\"size\":0,\"title\":\"File Public Link Revoked Activity Timechart\",\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"slack_file_activity\"},\"customWidth\":\"50\",\"name\":\"File Public Link Revoked Activity Timechart\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\" SlackAudit\\n | extend evt_time = unixtime_seconds_todatetime(EventEndTime)\\n | where evt_time {TimeRange}\\n | where Action == \\\"file_public_link_revoked\\\"\\n | project Time =evt_time, Workspace=ContextLocationName, [\\\"File Title\\\"] = EntityFileTitle, User = ActorUserName, Action, ActionDescription\\n | sort by Time desc | take 100\",\"size\":0,\"title\":\"File Public Link Revoked Activity\",\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"slack_file_activity\"},\"customWidth\":\"50\",\"name\":\"File Public Link Revoked Activity\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"\\nSlackAudit | extend evt_time = unixtime_seconds_todatetime(EventEndTime)\\n| where Action contains \\\"_channel_\\\"\\n| summarize count() by ActionDescription | sort by count_ desc\",\"size\":1,\"title\":\"Channels Activity\",\"timeContext\":{\"durationMs\":172800000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"ActionDescription\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"count_\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"useGrouping\":false,\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"showBorder\":false}},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"slack_channels_activity\"},\"name\":\"Channels Activity\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SlackAudit | extend evt_time = unixtime_seconds_todatetime(EventEndTime)\\n| where evt_time {TimeRange}\\n| where Action contains \\\"private_channel\\\"\\n| summarize count() by ActionDescription\",\"size\":0,\"title\":\"Private Channels Activity\",\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"slack_channels_activity\"},\"customWidth\":\"50\",\"name\":\"Private Channels Activity\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SlackAudit | extend evt_time = unixtime_seconds_todatetime(EventEndTime)\\n| where evt_time {TimeRange}\\n| where Action contains \\\"private_channel\\\"\\n| project Time=evt_time, ActorUser=ActorUserEmail, Action, ActionDescription, [\\\"Channel Name\\\"]= EntityChannelName, ContextLocationDomain, Ip=ContextIpAddress, EntityChannelIsShared,EntityChannelIsOrgShared\\n| sort by Time\",\"size\":0,\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"slack_channels_activity\"},\"customWidth\":\"50\",\"name\":\"PrivateChannelActivity\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SlackAudit | extend evt_time = unixtime_seconds_todatetime(EventEndTime)\\n| where evt_time {TimeRange}\\n| where Action contains \\\"public_channel\\\"\\n| summarize count() by ActionDescription\",\"size\":0,\"title\":\"Public Channels Activity\",\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"slack_channels_activity\"},\"customWidth\":\"50\",\"name\":\"Public Channels Activity\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SlackAudit | extend evt_time = unixtime_seconds_todatetime(EventEndTime)\\n| where evt_time {TimeRange}\\n| where Action contains \\\"public_channel\\\"\\n| project Time=evt_time, ActorUser=ActorUserEmail, Action, ActionDescription, [\\\"Channel Name\\\"]= EntityChannelName, ContextLocationDomain, Ip=ContextIpAddress, EntityChannelIsShared,EntityChannelIsOrgShared\\n| sort by Time\",\"size\":0,\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"slack_channels_activity\"},\"customWidth\":\"50\",\"name\":\"PublicChannelActivity\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SlackAudit | extend evt_time = unixtime_seconds_todatetime(EventEndTime)\\n| where evt_time {TimeRange}\\n| where Action contains \\\"guest_channel\\\"\\n| summarize count() by ActionDescription\",\"size\":0,\"title\":\"Guest Channels Activity\",\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"barchart\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"slack_channels_activity\"},\"customWidth\":\"50\",\"name\":\"Guest Channels Activity\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SlackAudit | extend evt_time = unixtime_seconds_todatetime(EventEndTime)\\n| where evt_time {TimeRange}\\n| where Action contains \\\"guest_channel\\\"\\n| project Time=evt_time, ActorUser=ActorUserEmail, Action, ActionDescription, [\\\"Channel Name\\\"]= EntityChannelName, ContextLocationDomain, Ip=ContextIpAddress, EntityChannelIsShared,EntityChannelIsOrgShared\\n| sort by Time\",\"size\":0,\"timeContext\":{\"durationMs\":2419200000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"conditionalVisibility\":{\"parameterName\":\"Tab\",\"comparison\":\"isEqualTo\",\"value\":\"slack_channels_activity\"},\"customWidth\":\"50\",\"name\":\"GuestChannelActivity\"}],\"fromTemplateId\":\"sentinel-SlackAudit\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
        "version": "1.0",
        "sourceId": "[variables('_workbook-source')]",
        "category": "sentinel"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic1-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "This query shows connections to the Slack Workspace with empty User Agent.",
        "displayName": "SlackAudit - Empty User Agent",
        "enabled": false,
        "query": "SlackAudit\n| where isempty(UserAgentOriginal)\n| extend AccountCustomEntity = SrcUserName\n",
        "queryFrequency": "P1D",
        "queryPeriod": "P1D",
        "severity": "Low",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess"
        ],
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "columnName": "AccountCustomEntity",
                "identifier": "FullName"
              }
            ],
            "entityType": "Account"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic2-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "This query helps to detect when a user uploads multiple archived files in short period of time.",
        "displayName": "SlackAudit - Multiple archived files uploaded in short period of time",
        "enabled": false,
        "query": "let threshold = 10;\nSlackAudit\n| where DvcAction =~ 'file_uploaded'\n| extend FE = extract(@'.*\\.(.*)$', 1, EntityFileName)\n| where FE in~ ('tar', 'bz2', 'gz', 'tgz', 'Z', 'tbz2', 'zst', 'zip', 'zipx', '7z', 'rar', 'sfx')\n| summarize count() by SrcUserName, bucket = bin(TimeGenerated, 15m)\n| where count_ > threshold\n| extend AccountCustomEntity = SrcUserName\n",
        "queryFrequency": "P1D",
        "queryPeriod": "P1D",
        "severity": "Low",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Exfiltration"
        ],
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "columnName": "AccountCustomEntity",
                "identifier": "FullName"
              }
            ],
            "entityType": "Account"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic3-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "This query helps to detect bruteforce of a user account.",
        "displayName": "SlackAudit - Multiple failed logins for user",
        "enabled": false,
        "query": "let threshold = 10;\nSlackAudit\n| where DvcAction =~ 'user_login_failed'\n| summarize count() by SrcUserName, bucket = bin(TimeGenerated, 5m)\n| where count_ > threshold\n| extend AccountCustomEntity = SrcUserName\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "CredentialAccess"
        ],
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "columnName": "AccountCustomEntity",
                "identifier": "FullName"
              }
            ],
            "entityType": "Account"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic4-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects public links for files which potentialy may contain sensitive data such as passwords, authentication tokens, secret keys.",
        "displayName": "SlackAudit - Public link created for file which can contain sensitive information.",
        "enabled": false,
        "query": "SlackAudit\n| where Action =~ 'file_public_link_created'\n| where EntityFileName == 'id_rsa' or EntityFileName contains 'password' or EntityFileName contains 'key' or EntityFileName contains '_key' or EntityFileName contains '.ssh' or EntityFileName endswith '.npmrc' or EntityFileName endswith '.muttrc' or EntityFileName contains 'config.json' or EntityFileName contains '.gitconfig' or EntityFileName endswith '.netrc' or EntityFileName endswith 'package.json' or EntityFileName endswith 'Gemfile' or EntityFileName endswith 'bower.json' or EntityFileName endswith 'config.gypi' or EntityFileName endswith 'travis.yml'\n| extend AccountCustomEntity = SrcUserName\n| extend IPCustomEntity = SrcIpAddr\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Exfiltration"
        ],
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "columnName": "AccountCustomEntity",
                "identifier": "FullName"
              }
            ],
            "entityType": "Account"
          },
          {
            "fieldMappings": [
              {
                "columnName": "IPCustomEntity",
                "identifier": "Address"
              }
            ],
            "entityType": "IP"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic5-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects potentialy suspicious downloads.",
        "displayName": "SlackAudit - Suspicious file downloaded.",
        "enabled": false,
        "query": "SlackAudit\n| where DvcAction =~ 'file_downloaded'\n| extend fe = split(EntityFileName, '.')\n| where array_length(fe) > 2\n| where fe[1] matches regex @\"\\D+\"\n| where strlen(fe[1]) < 5\n| project EntityFileName, SrcUserName\n| extend AccountCustomEntity = SrcUserName\n| extend FileCustomEntity = EntityFileName\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess"
        ],
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "columnName": "AccountCustomEntity",
                "identifier": "FullName"
              }
            ],
            "entityType": "Account"
          },
          {
            "fieldMappings": [
              {
                "columnName": "FileCustomEntity",
                "identifier": "Name"
              }
            ],
            "entityType": "File"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic6-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "This query helps to detect who trying to connect to the Slack Workspace with unknown User Agent.",
        "displayName": "SlackAudit - Unknown User Agent",
        "enabled": false,
        "query": "let lbperiod = 14d;\nlet known_UAs = SlackAudit\n| where TimeGenerated > ago(lbperiod)\n| where isnotempty(UserAgentOriginal)\n| summarize makeset(UserAgentOriginal);\nSlackAudit\n| where UserAgentOriginal !in (known_UAs)\n| extend AccountCustomEntity = SrcUserName\n",
        "queryFrequency": "PT24H",
        "queryPeriod": "P14D",
        "severity": "Low",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Persistence"
        ],
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "columnName": "AccountCustomEntity",
                "identifier": "FullName"
              }
            ],
            "entityType": "Account"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic7-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "This query helps to detect a change in the users role to admin or owner.",
        "displayName": "SlackAudit - User role changed to admin or owner",
        "enabled": false,
        "query": "SlackAudit\n| where DvcAction in~ ('role_change_to_admin', 'role_change_to_owner')\n| extend AccountCustomEntity = SrcUserName\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Low",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Persistence",
          "PrivilegeEscalation"
        ],
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "columnName": "AccountCustomEntity",
                "identifier": "FullName"
              }
            ],
            "entityType": "Account"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic8-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects when user email linked to account changes.",
        "displayName": "SlackAudit - User email linked to account changed.",
        "enabled": false,
        "query": "SlackAudit\n| where TimeGenerated between (ago(14d) .. (1d))\n| summarize max(TimeGenerated) by SrcUserName, SrcUserEmail\n| join (SlackAudit \n      | where Action =~ 'user_login'\n      | project SrcIpAddr, SrcUserName, NewUserEmail = SrcUserEmail) on SrcUserName\n| where NewUserEmail != SrcUserEmail\n| extend AccountCustomEntity = SrcUserName\n| extend IPCustomEntity = SrcIpAddr\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "P14D",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess"
        ],
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "columnName": "AccountCustomEntity",
                "identifier": "FullName"
              }
            ],
            "entityType": "Account"
          },
          {
            "fieldMappings": [
              {
                "columnName": "IPCustomEntity",
                "identifier": "Address"
              }
            ],
            "entityType": "IP"
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic9-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects when user email linked to account changes.",
        "displayName": "SlackAudit - User login after deactivated.",
        "enabled": false,
        "query": "let lbperiod_max_d = 14d;\nlet lbperiod_min_d = 1d;\nlet lb_time_max_h = 24h;\nSlackAudit\n| where TimeGenerated between (ago(lbperiod_max_d) .. (lbperiod_min_d))\n| where Action =~ 'user_deactivated'\n| summarize deactivation_time = max(TimeGenerated) by EntityUserEmail, EntityUserId\n| project deactivation_time, EntityUserEmail, EntityUserId\n| join (SlackAudit\n      | where TimeGenerated > ago(lb_time_max_h)\n      | where Action =~ 'user_login'\n      | summarize new_login_time = max(TimeGenerated) by SrcUserEmail, SrcUserIdentity\n      | project new_login_time, SrcUserEmail, EntityUserId = SrcUserIdentity) on EntityUserId\n| where EntityUserEmail == SrcUserEmail\n| where deactivation_time < new_login_time\n| extend AccountCustomEntity = SrcUserEmail\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "P14D",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess",
          "Persistence",
          "PrivilegeEscalation"
        ],
        "entityMappings": [
          {
            "fieldMappings": [
              {
                "columnName": "AccountCustomEntity",
                "identifier": "FullName"
              }
            ],
            "entityType": "Account"
          }
        ]
      }
    },
    {
      "id": "[variables('_connector1-source')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('connector1-name'))]",
      "apiVersion": "2021-03-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "location": "[parameters('workspace-location')]",
      "kind": "GenericUI",
      "properties": {
        "connectorUiConfig": {
          "title": "Slack Audit",
          "publisher": "Slack",
          "descriptionMarkdown": "The [Slack](https://slack.com) Audit data connector provides the capability to ingest [Slack Audit Records](https://api.slack.com/admins/audit-logs) events into Azure Sentinel through the REST API. Refer to [API documentation](https://api.slack.com/admins/audit-logs#the_audit_event) for more information. The connector provides ability to get events which helps to examine potential security risks, analyze your team's use of collaboration, diagnose configuration problems and more.",
          "graphQueries": [
            {
              "metricName": "Total data received",
              "legend": "SlackAudit_CL",
              "baseQuery": "SlackAudit_CL"
            }
          ],
          "sampleQueries": [
            {
              "description": "Slack Audit Events - All Activities.",
              "query": "SlackAudit\n | sort by TimeGenerated desc"
            }
          ],
          "dataTypes": [
            {
              "name": "SlackAudit_CL",
              "lastDataReceivedQuery": "SlackAudit_CL\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriterias": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "SlackAudit_CL\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)"
              ]
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": true
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions on the workspace are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              },
              {
                "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                "providerDisplayName": "Keys",
                "scope": "Workspace",
                "requiredPermissions": {
                  "action": true
                }
              }
            ],
            "customs": [
              {
                "name": "Microsoft.Web/sites permissions",
                "description": "Read and write permissions to Azure Functions to create a Function App is required. [See the documentation to learn more about Azure Functions](https://docs.microsoft.com/azure/azure-functions/)."
              },
              {
                "name": "REST API Credentials/permissions",
                "description": "**SlackAPIBearerToken** is required for REST API. [See the documentation to learn more about API](https://api.slack.com/web#authentication). Check all [requirements and follow  the instructions](https://api.slack.com/web#authentication) for obtaining credentials."
              }
            ]
          },
          "instructionSteps": [
            {
              "description": ">**NOTE:** This connector uses Azure Functions to connect to the Slack REST API to pull its logs into Azure Sentinel. This might result in additional data ingestion costs. Check the [Azure Functions pricing page](https://azure.microsoft.com/pricing/details/functions/) for details."
            },
            {
              "description": ">**(Optional Step)** Securely store workspace and API authorization key(s) or token(s) in Azure Key Vault. Azure Key Vault provides a secure mechanism to store and retrieve key values. [Follow these instructions](https://docs.microsoft.com/azure/app-service/app-service-key-vault-references) to use Azure Key Vault with an Azure Function App."
            },
            {
              "description": ">**NOTE:** This data connector depends on a parser based on a Kusto Function to work as expected. [Follow these steps](https://aka.ms/sentinel-SlackAuditAPI-parser) to create the Kusto functions alias, **SlackAudit**"
            },
            {
              "description": "**STEP 1 - Configuration steps for the Slack API**\n\n [Follow the instructions](https://api.slack.com/web#authentication) to obtain the credentials. \n"
            },
            {
              "description": "**STEP 2 - Choose ONE from the following two deployment options to deploy the connector and the associated Azure Function**\n\n>**IMPORTANT:** Before deploying the Slack Audit data connector, have the Workspace ID and Workspace Primary Key (can be copied from the following).",
              "instructions": [
                {
                  "parameters": {
                    "fillWith": [
                      "WorkspaceId"
                    ],
                    "label": "Workspace ID"
                  },
                  "type": "CopyableLabel"
                },
                {
                  "parameters": {
                    "fillWith": [
                      "PrimaryKey"
                    ],
                    "label": "Primary Key"
                  },
                  "type": "CopyableLabel"
                }
              ]
            },
            {
              "description": "Use this method for automated deployment of the Slack Audit data connector using an ARM Tempate.\n\n1. Click the **Deploy to Azure** button below. \n\n\t[![Deploy To Azure](https://aka.ms/deploytoazurebutton)](https://aka.ms/sentinel-SlackAuditAPI-azuredeploy)\n2. Select the preferred **Subscription**, **Resource Group** and **Location**. \n> **NOTE:** Within the same resource group, you can't mix Windows and Linux apps in the same region. Select existing resource group without Windows apps in it or create new resource group.\n3. Enter the **SlackAPIBearerToken** and deploy. \n4. Mark the checkbox labeled **I agree to the terms and conditions stated above**. \n5. Click **Purchase** to deploy.",
              "title": "Option 1 - Azure Resource Manager (ARM) Template"
            },
            {
              "description": "Use the following step-by-step instructions to deploy the Slack Audit data connector manually with Azure Functions (Deployment via Visual Studio Code).",
              "title": "Option 2 - Manual Deployment of Azure Functions"
            },
            {
              "description": "**1. Deploy a Function App**\n\n> **NOTE:** You will need to [prepare VS code](https://docs.microsoft.com/azure/azure-functions/functions-create-first-function-python#prerequisites) for Azure function development.\n\n1. Download the [Azure Function App](https://aka.ms/sentinel-SlackAuditAPI-functionapp) file. Extract archive to your local development computer.\n2. Start VS Code. Choose File in the main menu and select Open Folder.\n3. Select the top level folder from extracted files.\n4. Choose the Azure icon in the Activity bar, then in the **Azure: Functions** area, choose the **Deploy to function app** button.\nIf you aren't already signed in, choose the Azure icon in the Activity bar, then in the **Azure: Functions** area, choose **Sign in to Azure**\nIf you're already signed in, go to the next step.\n5. Provide the following information at the prompts:\n\n\ta. **Select folder:** Choose a folder from your workspace or browse to one that contains your function app.\n\n\tb. **Select Subscription:** Choose the subscription to use.\n\n\tc. Select **Create new Function App in Azure** (Don't choose the Advanced option)\n\n\td. **Enter a globally unique name for the function app:** Type a name that is valid in a URL path. The name you type is validated to make sure that it's unique in Azure Functions. (e.g. SlackAuditXXXXX).\n\n\te. **Select a runtime:** Choose Python 3.8.\n\n\tf. Select a location for new resources. For better performance and lower costs choose the same [region](https://azure.microsoft.com/regions/) where Azure Sentinel is located.\n\n6. Deployment will begin. A notification is displayed after your function app is created and the deployment package is applied.\n7. Go to Azure Portal for the Function App configuration."
            },
            {
              "description": "**2. Configure the Function App**\n\n1. In the Function App, select the Function App Name and select **Configuration**.\n2. In the **Application settings** tab, select ** New application setting**.\n3. Add each of the following application settings individually, with their respective string values (case-sensitive): \n\t\tSlackAPIBearerToken\n\t\tWorkspaceID\n\t\tWorkspaceKey\n\t\tlogAnalyticsUri (optional)\n> - Use logAnalyticsUri to override the log analytics API endpoint for dedicated cloud. For example, for public cloud, leave the value empty; for Azure GovUS cloud environment, specify the value in the following format: `https://<CustomerId>.ods.opinsights.azure.us`.\n3. Once all application settings have been entered, click **Save**."
            }
          ],
          "additionalRequirementBanner": "These queries and workbooks are dependent on a parser based on Kusto to work as expected. ​Follow the steps to use this Kusto functions alias **SlackAudit** in queries and workbooks [Follow steps to get this Kusto functions>](https://aka.ms/sentinel-SlackAuditAPI-parser)."
        }
      }
    },
    {
      "id": "[variables('_connector2-source')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('connector2-name'))]",
      "apiVersion": "2021-03-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "location": "[parameters('workspace-location')]",
      "kind": "APIPolling",
      "properties": {
        "connectorUiConfig": {
          "title": "Slack",
          "publisher": "Slack",
          "descriptionMarkdown": "The [Slack](https://slack.com) data connector provides the capability to ingest [Slack Audit Records](https://api.slack.com/admins/audit-logs) events into Microsoft Sentinel through the REST API. Refer to [API documentation](https://api.slack.com/admins/audit-logs#the_audit_event) for more information. The connector provides ability to get events which helps to examine potential security risks, analyze your team's use of collaboration, diagnose configuration problems and more. This data connector uses Microsoft Sentinel native polling capability.",
          "graphQueriesTableName": "SlackAuditNativePoller_CL",
          "graphQueries": [
            {
              "metricName": "Total data received",
              "legend": "Slack audit events",
              "baseQuery": "{{graphQueriesTableName}}"
            }
          ],
          "sampleQueries": [
            {
              "description": "All Slack audit events",
              "query": "{{graphQueriesTableName}}\n| sort by TimeGenerated desc"
            }
          ],
          "dataTypes": [
            {
              "name": "{{graphQueriesTableName}}",
              "lastDataReceivedQuery": "{{graphQueriesTableName}}\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriteria": [
            {
              "type": "SentinelKindsV2",
              "value": []
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": true
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              },
              {
                "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key)",
                "providerDisplayName": "Keys",
                "scope": "Workspace",
                "requiredPermissions": {
                  "action": true
                }
              }
            ],
            "customs": [
              {
                "name": "Slack API credentials",
                "description": "**SlackAPIBearerToken** is required for REST API. [See the documentation to learn more about API](https://api.slack.com/web#authentication). Check all [requirements and follow the instructions](https://api.slack.com/web#authentication) for obtaining credentials."
              }
            ]
          },
          "instructionSteps": [
            {
              "title": "Connect Slack to Microsoft Sentinel",
              "description": "Enable Slack audit Logs.",
              "instructions": [
                {
                  "parameters": {
                    "enable": "true"
                  },
                  "type": "APIKey"
                }
              ]
            }
          ]
        },
        "pollingConfig": {
          "auth": {
            "authType": "APIKey",
            "APIKeyName": "Authorization",
            "APIKeyIdentifier": "Bearer"
          },
          "request": {
            "apiEndpoint": "https://api.slack.com/audit/v1/logs",
            "httpMethod": "Get",
            "queryTimeFormat": "UnixTimestamp",
            "startTimeAttributeName": "oldest",
            "endTimeAttributeName": "latest",
            "queryWindowInMin": 5,
            "queryParameters": {
              "limit": 1000
            }
          },
          "paging": {
            "pagingType": "PageToken",
            "nextPageParaName": "cursor",
            "nextPageTokenJsonPath": "..response_metadata.next_cursor"
          },
          "response": {
            "eventsJsonPaths": [
              "$..entries"
            ]
          }
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2020-08-01",
      "name": "[parameters('workspace')]",
      "location": "[parameters('workspace-location')]",
      "resources": [
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "SlackAudit Data Parser",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "SlackAudit Data Parser",
            "category": "Samples",
            "functionAlias": "SlackAudit",
            "query": "\nlet SlackAudit_view  = view () { \n    union isfuzzy=true SlackAudit_CL, SlackAuditNativePoller_CL\n    | extend \n        EventVendor=\"Slack\",\n        EventProduct=\"Slack Audit Logs\",\n\t\tDetailsMobileOnly=column_ifexists('details_mobile_only_b', ''),\n\t\tDetailsWebOnly=column_ifexists('details_web_only_b', ''),\n\t\tDetailsKickerId=column_ifexists('details_kicker_id_s', ''),\n\t\tDetailsKickerName=column_ifexists('details_kicker_name_s', ''),\n\t\tDetailsKickerEmail=column_ifexists('details_kicker_email_s', ''),\n\t\tDetailsKickerTeam=column_ifexists('details_kicker_team_s', ''),\n\t\tDetailsAppOwnerId=column_ifexists('details_app_owner_id_s', ''),\n\t\tDetailsGranularBotToken=column_ifexists('details_granular_bot_token_b', ''),\n\t\tDetailsNewScopes=column_ifexists('details_new_scopes_s', ''),\n\t\tDetailsPreviousScopes=column_ifexists('details_previous_scopes_s', ''),\n\t\tEntityUsergroupId=column_ifexists('entity_usergroup_id_s', ''),\n\t\tEntityUsergroupName=column_ifexists('entity_usergroup_name_s', ''),\n\t\tDetailsKickerType=column_ifexists('details_kicker_type_s', ''),\n\t\tDetailsKickerUserId=column_ifexists('details_kicker_user_id_s', ''),\n\t\tDetailsKickerUserName=column_ifexists('details_kicker_user_name_s', ''),\n\t\tDetailsKickerUserEmail=column_ifexists('details_kicker_user_email_s', ''),\n\t\tDetailsKickerUserTeam=column_ifexists('details_kicker_user_team_s', ''),\n\t\tDetailsInviterId=column_ifexists('details_inviter_id_s', ''),\n\t\tDetailsInviterName=column_ifexists('details_inviter_name_s', ''),\n\t\tDetailsInviterEmail=column_ifexists('details_inviter_email_s', ''),\n\t\tDetailsInviterTeam=column_ifexists('details_inviter_team_s', ''),\n\t\tDetailsInviterType=column_ifexists('details_inviter_type_s', ''),\n\t\tDetailsInviterUserId=column_ifexists('details_inviter_user_id_s', ''),\n\t\tDetailsInviterUserName=column_ifexists('details_inviter_user_name_s', ''),\n\t\tDetailsInviterUserEmail=column_ifexists('details_inviter_user_email_s', ''),\n\t\tDetailsInviterUserTeam=column_ifexists('details_inviter_user_team_s', ''),\n\t\tDetailsIsWorkflow=column_ifexists('details_is_workflow_b', ''),\n\t\tEntityAppId=column_ifexists('entity_app_id_s', ''),\n\t\tEntityAppName=column_ifexists('entity_app_name_s', ''),\n\t\tEntityAppIsDistributed=column_ifexists('entity_app_is_distributed_b', ''),\n\t\tEntityAppIsDirectoryApproved=column_ifexists('entity_app_is_directory_approved_b', ''),\n\t\tEntityAppIsWorkflowApp=column_ifexists('entity_app_is_workflow_app_b', ''),\n\t\tEntityAppScopes=column_ifexists('entity_app_scopes_s', ''),\n\t\tDetailsIsInternalIntegration=column_ifexists('details_is_internal_integration_b', ''),\n\t\tDetailsBotScopes=column_ifexists('details_bot_scopes_s', ''),\n\t\tEntityChannelId=column_ifexists('entity_channel_id_s', ''),\n\t\tEntityChannelPrivacy=column_ifexists('entity_channel_privacy_s', ''),\n\t\tEntityChannelName=column_ifexists('entity_channel_name_s', ''),\n\t\tEntityChannelIsShared=column_ifexists('entity_channel_is_shared_b', ''),\n\t\tEntityChannelIsOrgShared=column_ifexists('entity_channel_is_org_shared_b', ''),\n\t\tDetailsType=column_ifexists('details_type_s', ''),\n\t\tEntityUserId=column_ifexists('entity_user_id_s', ''),\n\t\tEntityUserName=column_ifexists('entity_user_name_s', ''),\n\t\tEntityUserEmail=column_ifexists('entity_user_email_s', ''),\n\t\tEntityUserTeam=column_ifexists('entity_user_team_s', ''),\n\t\tId=column_ifexists('id_g', ''),\n\t\tDateCreate=column_ifexists('date_create_d', ''),\n\t\tAction=column_ifexists('action_s', ''),\n\t\tActorType=column_ifexists('actor_type_s', ''),\n\t\tActorUserId=column_ifexists('actor_user_id_s', ''),\n\t\tActorUserName=column_ifexists('actor_user_name_s', ''),\n\t\tActorUserEmail=column_ifexists('actor_user_email_s', ''),\n\t\tActorUserTeam=column_ifexists('actor_user_team_s', ''),\n\t\tEntityType=column_ifexists('entity_type_s', ''),\n\t\tEntityFileId=column_ifexists('entity_file_id_s', ''),\n\t\tEntityFileName=column_ifexists('entity_file_name_s', ''),\n\t\tEntityFileFiletype=column_ifexists('entity_file_filetype_s', ''),\n\t\tEntityFileTitle=column_ifexists('entity_file_title_s', ''),\n\t\tContextLocationType=column_ifexists('context_location_type_s', ''),\n\t\tContextLocationId=column_ifexists('context_location_id_s', ''),\n\t\tContextLocationName=column_ifexists('context_location_name_s', ''),\n\t\tContextLocationDomain=column_ifexists('context_location_domain_s', ''),\n\t\tContextUA=column_ifexists('context_ua_s', ''),\n\t\tContextIpAddress=column_ifexists('context_ip_address_s', ''),\n\t\tContextSessionId=column_ifexists('context_session_id_d', ''),\n\t\tActionDescription=column_ifexists('action_description_s', ''),\n        EventId=column_ifexists('id_g', ''),\n        EventEndTime=column_ifexists('date_create_d', ''),\n        DvcAction=column_ifexists('action_s', ''),\n        SrcUserIdentity=column_ifexists('actor_user_id_s', ''),\n        SrcUserName=column_ifexists('actor_user_name_s', ''),\n        SrcUserEmail=column_ifexists('actor_user_email_s', ''),\n        UserAgentOriginal=column_ifexists('context_ua_s', ''),\n        SrcIpAddr=column_ifexists('context_ip_address_s', ''),\n        DvcActionDesc=column_ifexists('action_description_s', '')\n    | project\n        TimeGenerated, \n        EventVendor,\n        EventProduct,\n        DetailsMobileOnly,\n\t\tDetailsWebOnly,\n\t\tDetailsKickerId,\n\t\tDetailsKickerName,\n\t\tDetailsKickerEmail,\n\t\tDetailsKickerTeam,\n\t\tDetailsAppOwnerId,\n\t\tDetailsGranularBotToken,\n\t\tDetailsNewScopes,\n\t\tDetailsPreviousScopes,\n\t\tEntityUsergroupId,\n\t\tEntityUsergroupName,\n\t\tDetailsKickerType,\n\t\tDetailsKickerUserId,\n\t\tDetailsKickerUserName,\n\t\tDetailsKickerUserEmail,\n\t\tDetailsKickerUserTeam,\n\t\tDetailsInviterId,\n\t\tDetailsInviterName,\n\t\tDetailsInviterEmail,\n\t\tDetailsInviterTeam,\n\t\tDetailsInviterType,\n\t\tDetailsInviterUserId,\n\t\tDetailsInviterUserName,\n\t\tDetailsInviterUserEmail,\n\t\tDetailsInviterUserTeam,\n\t\tDetailsIsWorkflow,\n\t\tEntityAppId,\n\t\tEntityAppName,\n\t\tEntityAppIsDistributed,\n\t\tEntityAppIsDirectoryApproved,\n\t\tEntityAppIsWorkflowApp,\n\t\tEntityAppScopes,\n\t\tDetailsIsInternalIntegration,\n\t\tDetailsBotScopes,\n\t\tEntityChannelId,\n\t\tEntityChannelPrivacy,\n\t\tEntityChannelName,\n\t\tEntityChannelIsShared,\n\t\tEntityChannelIsOrgShared,\n\t\tDetailsType,\n\t\tEntityUserId,\n\t\tEntityUserName,\n\t\tEntityUserEmail,\n\t\tEntityUserTeam,\n\t\tId,\n\t\tDateCreate,\n\t\tAction,\n\t\tActorType,\n\t\tActorUserId,\n\t\tActorUserName,\n\t\tActorUserEmail,\n\t\tActorUserTeam,\n\t\tEntityType,\n\t\tEntityFileId,\n\t\tEntityFileName,\n\t\tEntityFileFiletype,\n\t\tEntityFileTitle,\n\t\tContextLocationType,\n\t\tContextLocationId,\n\t\tContextLocationName,\n\t\tContextLocationDomain,\n\t\tContextUA,\n\t\tContextIpAddress,\n\t\tContextSessionId,\n\t\tActionDescription,\n        EventId,\n        EventEndTime,\n        DvcAction,\n        SrcUserIdentity,\n        SrcUserName,\n        SrcUserEmail,\n        UserAgentOriginal,\n        SrcIpAddr,\n        DvcActionDesc\n};\nSlackAudit_view",
            "version": 1
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "SlackAudit Hunting Query 1",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "SlackAudit - Applications installed",
            "category": "Hunting Queries",
            "query": "SlackAudit\n| where TimeGenerated > ago(24h)\n| where DvcAction =~ 'app_installed'\n| summarize by SrcUserName, EntityAppName\n| extend AccountCustomEntity = SrcUserName\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "This query searches for application installation events."
              },
              {
                "name": "tactics",
                "value": "InitialAccess"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "SlackAudit Hunting Query 2",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "SlackAudit - Deactivated users",
            "category": "Hunting Queries",
            "query": "SlackAudit\n| where TimeGenerated > ago(24h)\n| where DvcAction =~ 'user_deactivated'\n| summarize by SrcUserName\n| extend AccountCustomEntity = SrcUserName\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "This query searches for deactivated user accounts."
              },
              {
                "name": "tactics",
                "value": "Impact"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "SlackAudit Hunting Query 3",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "SlackAudit - Downloaded files stats",
            "category": "Hunting Queries",
            "query": "SlackAudit\n| where TimeGenerated > ago(24h)\n| where Action =~ 'file_downloaded'\n| summarize filelist = makeset(EntityFileName) by SrcUserName\n| project filelist, fcount = array_length(filelist), SrcUserName\n| top 10 by fcount\n| extend AccountCustomEntity = SrcUserName\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "This query shows top users by downloads over time."
              },
              {
                "name": "tactics",
                "value": "InitialAccess"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "SlackAudit Hunting Query 4",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "SlackAudit - Failed logins with unknown username",
            "category": "Hunting Queries",
            "query": "let lbtime = 24h;\nlet lbperiod = 30d;\nlet known_users = SlackAudit\n| where TimeGenerated > ago(lbperiod)\n| where DvcAction =~ 'user_login'\n| where isnotempty(SrcUserName)\n| summarize makeset(SrcUserName);\nSlackAudit\n| where TimeGenerated > ago(lbtime)\n| where DvcAction =~ 'user_login_failed'\n| where isnotempty(SrcUserName)\n| where SrcUserName !in (known_users)\n| project SrcUserName, SrcIpAddr\n| extend AccountCustomEntity = SrcUserName\n| extend IPCustomEntity = SrcIpAddr\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "This query shows failed login attempts where username is unknown."
              },
              {
                "name": "tactics",
                "value": "CredentialAccess"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "SlackAudit Hunting Query 5",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "SlackAudit - New User created",
            "category": "Hunting Queries",
            "query": "SlackAudit\n| where TimeGenerated > ago(24h)\n| where DvcAction =~ 'user_created'\n| extend AccountCustomEntity = SrcUserName\n| extend IPCustomEntity = SrcIpAddr\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "This query shows new user created."
              },
              {
                "name": "tactics",
                "value": "Persistence"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "SlackAudit Hunting Query 6",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "SlackAudit - Suspicious files downloaded",
            "category": "Hunting Queries",
            "query": "SlackAudit\n| where TimeGenerated > ago(lbtime)\n| where DvcAction =~ 'file_downloaded'\n| extend fe = split(EntityFileName, '.')\n| where array_length(fe) > 2\n| where fe[1] matches regex @\"\\D+\"\n| where strlen(fe[1]) < 5\n| project EntityFileName, SrcUserName\n| extend AccountCustomEntity = SrcUserName\n| extend FileCustomEntity = EntityFileName\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "This query searches for potentialy suspicious files downloads."
              },
              {
                "name": "tactics",
                "value": "InitialAccess"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "SlackAudit Hunting Query 7",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "SlackAudit - Uploaded files stats",
            "category": "Hunting Queries",
            "query": "SlackAudit\n| where TimeGenerated > ago(24h)\n| where Action =~ 'file_uploaded'\n| summarize filelist = makeset(EntityFileName) by SrcUserName\n| project filelist, fcount = array_length(filelist), SrcUserName\n| top 10 by fcount\n| extend AccountCustomEntity = SrcUserName\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "This query shows top users by uploads over time."
              },
              {
                "name": "tactics",
                "value": "Exfiltration"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "SlackAudit Hunting Query 8",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "SlackAudit - User logins by IP",
            "category": "Hunting Queries",
            "query": "SlackAudit\n| where TimeGenerated > ago(24h)\n| where DvcAction =~ 'user_login'\n| summarize makeset(SrcIpAddr) by SrcUserName\n| extend AccountCustomEntity = SrcUserName\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "This query shows user IP table statistics for login events."
              },
              {
                "name": "tactics",
                "value": "InitialAccess,Persistence"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "SlackAudit Hunting Query 9",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "SlackAudit - User Permission Changed",
            "category": "Hunting Queries",
            "query": "SlackAudit\n| where TimeGenerated > ago(24h)\n| where DvcAction in~ ('user_added_to_usergroup', 'user_removed_from_usergroup')\n| extend AccountCustomEntity = SrcUserName\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for user permissions changes events."
              },
              {
                "name": "tactics",
                "value": "PrivilegeEscalation"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "SlackAudit Hunting Query 10",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "SlackAudit - Users joined channels without invites",
            "category": "Hunting Queries",
            "query": "SlackAudit\n| where TimeGenerated > ago(24h)\n| where DvcAction =~ 'user_channel_join'\n| where DetailsType =~ 'JOINED'\n| extend AccountCustomEntity = SrcUserName\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for users which joined channels without invites."
              },
              {
                "name": "tactics",
                "value": "InitialAccess,Persistence"
              }
            ]
          }
        }
      ]
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "version": "1.0.5",
        "kind": "Solution",
        "contentId": "[variables('_sourceId')]",
        "parentId": "[variables('_sourceId')]",
        "source": {
          "kind": "Solution",
          "name": "SlackAudit",
          "sourceId": "[variables('_sourceId')]"
        },
        "author": {
          "name": "Nikhil Tripathi",
          "email": "v-ntripathi@microsoft.com"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "Workbook",
              "contentId": "[variables('_SlackAudit_workbook')]",
              "version": "1.0.5"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_SlackAuditEmptyUA_AnalyticalRules')]",
              "version": "1.0.5"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_SlackAuditMultipleArchivedFilesUploadedInShortTimePeriod_AnalyticalRules')]",
              "version": "1.0.5"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_SlackAuditMultipleFailedLoginsForUser_AnalyticalRules')]",
              "version": "1.0.5"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_SlackAuditSensitiveFile_AnalyticalRules')]",
              "version": "1.0.5"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_SlackAuditSuspiciousFileDownloaded_AnalyticalRules')]",
              "version": "1.0.5"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_SlackAuditUnknownUA_AnalyticalRules')]",
              "version": "1.0.5"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_SlackAuditUserChangedToAdminOrOwner_AnalyticalRules')]",
              "version": "1.0.5"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_SlackAuditUserEmailChanged_AnalyticalRules')]",
              "version": "1.0.5"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_SlackAuditUserLoginAfterDeactivated_AnalyticalRules')]",
              "version": "1.0.5"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_SlackAuditAPIConnector')]",
              "version": "1.0.5"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_Connector')]",
              "version": "1.0.5"
            },
            {
              "kind": "Parser",
              "contentId": "[variables('_SlackAudit_Parser')]",
              "version": "1.0.5"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_SlackAuditApplicationsInstalled_HuntingQueries')]",
              "version": "1.0.5"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_SlackAuditDeactivatedUsers_HuntingQueries')]",
              "version": "1.0.5"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_SlackAuditDownloadedFilesByUser_HuntingQueries')]",
              "version": "1.0.5"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_SlackAuditFailedLoginsUnknownUsername_HuntingQueries')]",
              "version": "1.0.5"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_SlackAuditNewUsers_HuntingQueries')]",
              "version": "1.0.5"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_SlackAuditSuspiciousFilesDownloaded_HuntingQueries')]",
              "version": "1.0.5"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_SlackAuditUploadedFilesByUser_HuntingQueries')]",
              "version": "1.0.5"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_SlackAuditUserLoginsByIP_HuntingQueries')]",
              "version": "1.0.5"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_SlackAuditUserPermissionsChanged_HuntingQueries')]",
              "version": "1.0.5"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_SlackAuditUsersJoinedChannelsWithoutInvites_HuntingQueries')]",
              "version": "1.0.5"
            }
          ]
        },
        "firstPublishDate": "2021-03-24",
        "providers": [
          "Slack"
        ],
        "categories": {
          "domains": [
            "Application"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_sourceId'))]"
    }
  ],
  "outputs": {}
}
