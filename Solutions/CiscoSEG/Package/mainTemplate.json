{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "Nikhil Tripathi - v-ntripathi@microsoft.com",
    "comments": "Solution template for Cisco SEG"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Sentinel is setup"
      }
    },
    "analytic1-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic2-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic3-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic4-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic5-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic6-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic7-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic8-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic9-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic10-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "analytic11-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the scheduled alert rule"
      }
    },
    "connector1-name": {
      "type": "string",
      "defaultValue": "4c343cd1-7db7-4728-8f09-f1c0c745a1c6"
    },
    "formattedTimeNow": {
      "type": "string",
      "defaultValue": "[utcNow('g')]",
      "metadata": {
        "description": "Appended to workbook displayNames to make them unique"
      }
    },
    "workbook1-id": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "minLength": 1,
      "metadata": {
        "description": "Unique id for the workbook"
      }
    },
    "workbook1-name": {
      "type": "string",
      "defaultValue": "Cisco SEG",
      "minLength": 1,
      "metadata": {
        "description": "Name for the workbook"
      }
    }
  },
  "variables": {
    "CiscoSEGDLPViolation_AnalyticalRules": "CiscoSEGDLPViolation_AnalyticalRules",
    "_CiscoSEGDLPViolation_AnalyticalRules": "[variables('CiscoSEGDLPViolation_AnalyticalRules')]",
    "CiscoSEGMaliciousAttachmentNotBlocked_AnalyticalRules": "CiscoSEGMaliciousAttachmentNotBlocked_AnalyticalRules",
    "_CiscoSEGMaliciousAttachmentNotBlocked_AnalyticalRules": "[variables('CiscoSEGMaliciousAttachmentNotBlocked_AnalyticalRules')]",
    "CiscoSEGMultipleLargeEmails_AnalyticalRules": "CiscoSEGMultipleLargeEmails_AnalyticalRules",
    "_CiscoSEGMultipleLargeEmails_AnalyticalRules": "[variables('CiscoSEGMultipleLargeEmails_AnalyticalRules')]",
    "CiscoSEGMultipleSuspiciousEmails_AnalyticalRules": "CiscoSEGMultipleSuspiciousEmails_AnalyticalRules",
    "_CiscoSEGMultipleSuspiciousEmails_AnalyticalRules": "[variables('CiscoSEGMultipleSuspiciousEmails_AnalyticalRules')]",
    "CiscoSEGPossibleOutbreak_AnalyticalRules": "CiscoSEGPossibleOutbreak_AnalyticalRules",
    "_CiscoSEGPossibleOutbreak_AnalyticalRules": "[variables('CiscoSEGPossibleOutbreak_AnalyticalRules')]",
    "CiscoSEGPotentialLinkToMalwareDownload_AnalyticalRules": "CiscoSEGPotentialLinkToMalwareDownload_AnalyticalRules",
    "_CiscoSEGPotentialLinkToMalwareDownload_AnalyticalRules": "[variables('CiscoSEGPotentialLinkToMalwareDownload_AnalyticalRules')]",
    "CiscoSEGSuspiciousLink_AnalyticalRules": "CiscoSEGSuspiciousLink_AnalyticalRules",
    "_CiscoSEGSuspiciousLink_AnalyticalRules": "[variables('CiscoSEGSuspiciousLink_AnalyticalRules')]",
    "CiscoSEGSuspiciousSenderDomain_AnalyticalRules": "CiscoSEGSuspiciousSenderDomain_AnalyticalRules",
    "_CiscoSEGSuspiciousSenderDomain_AnalyticalRules": "[variables('CiscoSEGSuspiciousSenderDomain_AnalyticalRules')]",
    "CiscoSEGUnclassifiedLink_AnalyticalRules": "CiscoSEGUnclassifiedLink_AnalyticalRules",
    "_CiscoSEGUnclassifiedLink_AnalyticalRules": "[variables('CiscoSEGUnclassifiedLink_AnalyticalRules')]",
    "CiscoSEGUnexpextedAttachment_AnalyticalRules": "CiscoSEGUnexpextedAttachment_AnalyticalRules",
    "_CiscoSEGUnexpextedAttachment_AnalyticalRules": "[variables('CiscoSEGUnexpextedAttachment_AnalyticalRules')]",
    "CiscoSEGUnscannableAttachment_AnalyticalRules": "CiscoSEGUnscannableAttachment_AnalyticalRules",
    "_CiscoSEGUnscannableAttachment_AnalyticalRules": "[variables('CiscoSEGUnscannableAttachment_AnalyticalRules')]",
    "CiscoSEGDroppedInMails_HuntingQueries": "CiscoSEGDroppedInMails_HuntingQueries",
    "_CiscoSEGDroppedInMails_HuntingQueries": "[variables('CiscoSEGDroppedInMails_HuntingQueries')]",
    "workspace-dependency": "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspace'))]",
    "CiscoSEGDroppedOutMails_HuntingQueries": "CiscoSEGDroppedOutMails_HuntingQueries",
    "_CiscoSEGDroppedOutMails_HuntingQueries": "[variables('CiscoSEGDroppedOutMails_HuntingQueries')]",
    "CiscoSEGFailedDKIMFailure_HuntingQueries": "CiscoSEGFailedDKIMFailure_HuntingQueries",
    "_CiscoSEGFailedDKIMFailure_HuntingQueries": "[variables('CiscoSEGFailedDKIMFailure_HuntingQueries')]",
    "CiscoSEGFailedDMARKFailure_HuntingQueries": "CiscoSEGFailedDMARKFailure_HuntingQueries",
    "_CiscoSEGFailedDMARKFailure_HuntingQueries": "[variables('CiscoSEGFailedDMARKFailure_HuntingQueries')]",
    "CiscoSEGFailedSPFFailure_HuntingQueries": "CiscoSEGFailedSPFFailure_HuntingQueries",
    "_CiscoSEGFailedSPFFailure_HuntingQueries": "[variables('CiscoSEGFailedSPFFailure_HuntingQueries')]",
    "CiscoSEGFailedTLSIn_HuntingQueries": "CiscoSEGFailedTLSIn_HuntingQueries",
    "_CiscoSEGFailedTLSIn_HuntingQueries": "[variables('CiscoSEGFailedTLSIn_HuntingQueries')]",
    "CiscoSEGFailedTLSOut_HuntingQueries": "CiscoSEGFailedTLSOut_HuntingQueries",
    "_CiscoSEGFailedTLSOut_HuntingQueries": "[variables('CiscoSEGFailedTLSOut_HuntingQueries')]",
    "CiscoSEGInsecureProtocol_HuntingQueries": "CiscoSEGInsecureProtocol_HuntingQueries",
    "_CiscoSEGInsecureProtocol_HuntingQueries": "[variables('CiscoSEGInsecureProtocol_HuntingQueries')]",
    "CiscoSEGSpamMails_HuntingQueries": "CiscoSEGSpamMails_HuntingQueries",
    "_CiscoSEGSpamMails_HuntingQueries": "[variables('CiscoSEGSpamMails_HuntingQueries')]",
    "CiscoSEGUsersReceivedSpam_HuntingQueries": "CiscoSEGUsersReceivedSpam_HuntingQueries",
    "_CiscoSEGUsersReceivedSpam_HuntingQueries": "[variables('CiscoSEGUsersReceivedSpam_HuntingQueries')]",
    "CiscoSEGEvent_Parser": "CiscoSEGEvent_Parser",
    "_CiscoSEGEvent_Parser": "[variables('CiscoSEGEvent_Parser')]",
    "connector1-source": "[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.OperationalInsights/workspaces/',parameters('workspace'),'/providers/Microsoft.SecurityInsights/dataConnectors/',parameters('connector1-name'))]",
    "_connector1-source": "[variables('connector1-source')]",
    "CiscoSEGConnector": "CiscoSEGConnector",
    "_CiscoSEGConnector": "[variables('CiscoSEGConnector')]",
    "CiscoSEG_workbook": "CiscoSEG_workbook",
    "_CiscoSEG_workbook": "[variables('CiscoSEG_workbook')]",
    "workbook-source": "[concat(resourceGroup().id, '/providers/Microsoft.OperationalInsights/workspaces/',parameters('workspace'))]",
    "_workbook-source": "[variables('workbook-source')]",
    "sourceId": "azuresentinel.azure-sentinel-solution-ciscoseg",
    "_sourceId": "[variables('sourceId')]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic1-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects DLP policy violation.",
        "displayName": "Cisco SEG - DLP policy violation",
        "enabled": false,
        "query": "CiscoSEGEvent\n| where NetworkDirection =~ 'Outgoing'\n| where tostring(AdditionalFields) has 'ESADLPVerdict'\n| extend dlp_verdict = extract(@'ESADLPVerdict\":\"(NOT_EVALUATED|NO TRIGGER|VIOLATION|NO VIOLATION)\"', 1, tostring(AdditionalFields))\n| where dlp_verdict =~ 'VIOLATION'\n| extend AccountCustomEntity = SrcUserName\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Exfiltration"
        ],
        "entityMappings": [
          {
            "entityType": "Account",
            "fieldMappings": [
              {
                "identifier": "Name",
                "columnName": "AccountCustomEntity"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic2-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects mails with malicious attachments which were not blocked.",
        "displayName": "Cisco SEG - Malicious attachment not blocked",
        "enabled": false,
        "query": "CiscoSEGEvent\n| where NetworkDirection =~ 'Incoming'\n| where SimplifiedDeviceAction =~ 'DELIVERED'\n| where tostring(AdditionalFields) has 'ESAAMPVerdict'\n| extend amp_verdict = extract(@'ESAAMPVerdict\":\"(NOT_EVALUATED|CLEAN|FA_PENDING|UNKNOWN|SKIPPED|UNSCANNABLE|LOW_RISK|MALICIOUS)\"', 1, tostring(AdditionalFields))\n| where amp_verdict =~ 'MALICIOUS'\n| extend AccountCustomEntity = DstUserName\n",
        "queryFrequency": "PT10M",
        "queryPeriod": "PT10M",
        "severity": "High",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess"
        ],
        "entityMappings": [
          {
            "entityType": "Account",
            "fieldMappings": [
              {
                "identifier": "Name",
                "columnName": "AccountCustomEntity"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic3-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects possible data exfiltration.",
        "displayName": "Cisco SEG - Multiple large emails sent to external recipient",
        "enabled": false,
        "query": "let e_theshold = 3;\nlet s_threshold = 10000000;\nCiscoSEGEvent\n| where AdditionalFields[15]['ESAMsgSize'] > s_threshold\n| where NetworkDirection =~ 'Outgoing'\n| extend rec_domain = extract(@'@(.*)', 1, DstUserName)\n| extend s_domain = extract(@'@(.*)', 1, SrcUserName)\n| where s_domain != rec_domain\n| summarize count() by SrcUserName\n| where count_ >= e_theshold\n| extend AccountCustomEntity = SrcUserName\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "Exfiltration"
        ],
        "entityMappings": [
          {
            "entityType": "Account",
            "fieldMappings": [
              {
                "identifier": "Name",
                "columnName": "AccountCustomEntity"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic4-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects possibly phishing emails.",
        "displayName": "Cisco SEG - Multiple suspiciuos attachments received",
        "enabled": false,
        "query": "let r_threshold = 5;\nCiscoSEGEvent\n| where NetworkDirection =~ 'Incoming'\n| where isnotempty(EventMessage)\n| where strlen(EventMessage) < 20\n| summarize rec=makeset(DstUserName) by EventMessage, bin(TimeGenerated, 10m)\n| where array_length(rec) > r_threshold\n| extend AccountCustomEntity = rec\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "High",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess"
        ],
        "entityMappings": [
          {
            "entityType": "Account",
            "fieldMappings": [
              {
                "identifier": "Name",
                "columnName": "AccountCustomEntity"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic5-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects possible outbreak activity.",
        "displayName": "Cisco SEG - Possible outbreak",
        "enabled": false,
        "query": "CiscoSEGEvent\n| where NetworkDirection =~ 'Incoming'\n| where tostring(AdditionalFields) has 'ESAOFVerdict'\n| extend of_verdict = extract(@'ESAOFVerdict\":\"(NOT_EVALUATED|POSITIVE|NEGATIVE)\"', 1, tostring(AdditionalFields))\n| where of_verdict =~ 'POSITIVE'\n| extend AccountCustomEntity = DstUserName\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess"
        ],
        "entityMappings": [
          {
            "entityType": "Account",
            "fieldMappings": [
              {
                "identifier": "Name",
                "columnName": "AccountCustomEntity"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic6-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects mails with suspicious links.",
        "displayName": "Cisco SEG - Potential phishing link",
        "enabled": false,
        "query": "let dl_cat = dynamic(['Illegal Downloads']);\nCiscoSEGEvent\n| where NetworkDirection =~ 'Incoming'\n| where tostring(AdditionalFields) has 'ESAURLDetails'\n| extend link_cat = extract(@\"'Category': '(.*?)'\", 1, tostring(AdditionalFields))\n| where link_cat in~ (dl_cat)\n| extend AccountCustomEntity = DstUserName\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess"
        ],
        "entityMappings": [
          {
            "entityType": "Account",
            "fieldMappings": [
              {
                "identifier": "Name",
                "columnName": "AccountCustomEntity"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic7-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects mails with suspicious links.",
        "displayName": "Cisco SEG - Suspicious link",
        "enabled": false,
        "query": "let bl_cat = dynamic(['Adult', 'Hacking', 'Cheating and Plagiarism', 'Child Abuse Content', 'Dating', 'Illegal Activities', 'Pornography']);\nCiscoSEGEvent\n| where NetworkDirection =~ 'Incoming'\n| where tostring(AdditionalFields) has 'ESAURLDetails'\n| extend link_cat = extract(@\"'Category': '(.*?)'\", 1, tostring(AdditionalFields))\n| where link_cat in~ (bl_cat)\n| extend AccountCustomEntity = DstUserName\n",
        "queryFrequency": "PT15M",
        "queryPeriod": "PT15M",
        "severity": "High",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess"
        ],
        "entityMappings": [
          {
            "entityType": "Account",
            "fieldMappings": [
              {
                "identifier": "Name",
                "columnName": "AccountCustomEntity"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic8-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects suspicious sender domain age.",
        "displayName": "Cisco SEG - Suspicious sender domain",
        "enabled": false,
        "query": "CiscoSEGEvent\n| where NetworkDirection =~ 'Incoming'\n| extend rec_domain = extract(@'@(.*)', 1, DstUserName)\n| extend s_domain = extract(@'@(.*)', 1, SrcUserName)\n| where s_domain != rec_domain\n| where tostring(AdditionalFields) has 'ESASDRDomainAge'\n| extend domain_age = extract(@'ESASDRDomainAge\":\"(.*days)\"', 1, tostring(AdditionalFields))\n| extend yy = toint(extract(@'(\\d+)\\syears', 1, domain_age))\n| extend mm = toint(extract(@'(\\d+)\\smonths', 1, domain_age))\n| extend dd = toint(extract(@'(\\d+)\\sdays', 1, domain_age))\n| where isempty(yy)\n| where isempty(mm) or mm <= 2\n| extend AccountCustomEntity = SrcUserName\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess"
        ],
        "entityMappings": [
          {
            "entityType": "Account",
            "fieldMappings": [
              {
                "identifier": "Name",
                "columnName": "AccountCustomEntity"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic9-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects mails with suspicious links.",
        "displayName": "Cisco SEG - Unexpected link",
        "enabled": false,
        "query": "let u_cat = dynamic(['Unclassified']);\nCiscoSEGEvent\n| where NetworkDirection =~ 'Incoming'\n| where tostring(AdditionalFields) has 'ESAURLDetails'\n| extend link_cat = extract(@\"'Category': '(.*?)'\", 1, tostring(AdditionalFields))\n| where link_cat in~ (u_cat)\n| extend AccountCustomEntity = DstUserName\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess"
        ],
        "entityMappings": [
          {
            "entityType": "Account",
            "fieldMappings": [
              {
                "identifier": "Name",
                "columnName": "AccountCustomEntity"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic10-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects possibly malicious attachments.",
        "displayName": "Cisco SEG - Unexpected attachment",
        "enabled": false,
        "query": "CiscoSEGEvent\n| where NetworkDirection =~ 'Incoming'\n| where tostring(AdditionalFields) has 'ESAAttachmentDetails'\n| extend attachment = replace_string(tostring(extract(@'\"ESAAttachmentDetails\":\"{(.*?):', 1, tostring(AdditionalFields))), \"'\", \"\")\n| where attachment endswith '.ps1' or attachment endswith '.lnk' or attachment endswith '.exe'\n| extend AccountCustomEntity = DstUserName\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "High",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess"
        ],
        "entityMappings": [
          {
            "entityType": "Account",
            "fieldMappings": [
              {
                "identifier": "Name",
                "columnName": "AccountCustomEntity"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('analytic11-id'))]",
      "apiVersion": "2021-03-01-preview",
      "kind": "Scheduled",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "description": "Detects unscannable attachments in mails.",
        "displayName": "Cisco SEG - Unscannable attacment",
        "enabled": false,
        "query": "CiscoSEGEvent\n| where NetworkDirection =~ 'Incoming'\n| where tostring(AdditionalFields) has 'ESAAMPVerdict'\n| extend amp_verdict = extract(@'ESAAMPVerdict\":\"(NOT_EVALUATED|CLEAN|FA_PENDING|UNKNOWN|SKIPPED|UNSCANNABLE|LOW_RISK|MALICIOUS)\"', 1, tostring(AdditionalFields))\n| where amp_verdict =~ 'UNSCANNABLE'\n| extend AccountCustomEntity = DstUserName\n",
        "queryFrequency": "PT1H",
        "queryPeriod": "PT1H",
        "severity": "Medium",
        "suppressionDuration": "PT1H",
        "suppressionEnabled": false,
        "triggerOperator": "GreaterThan",
        "triggerThreshold": 0,
        "tactics": [
          "InitialAccess"
        ],
        "entityMappings": [
          {
            "entityType": "Account",
            "fieldMappings": [
              {
                "identifier": "Name",
                "columnName": "AccountCustomEntity"
              }
            ]
          }
        ]
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2020-08-01",
      "name": "[parameters('workspace')]",
      "location": "[parameters('workspace-location')]",
      "resources": [
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Cisco SEG Hunting Query 1",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Cisco SEG - Dropped incoming mails",
            "category": "Hunting Queries",
            "query": "CiscoSEGEvent\n| where TimeGenerated > ago(24h)\n| where NetworkDirection =~ 'Incoming'\n| where SimplifiedDeviceAction =~ 'DROPPED'\n| summarize count() by DstUserName\n| extend AccountCustomEntity = DstUserName\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for dropped mails."
              },
              {
                "name": "tactics",
                "value": "InitialAccess"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Cisco SEG Hunting Query 2",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Cisco SEG - Dropped outgoing mails",
            "category": "Hunting Queries",
            "query": "CiscoSEGEvent\n| where TimeGenerated > ago(24h)\n| where NetworkDirection =~ 'Outgoing'\n| where SimplifiedDeviceAction =~ 'DROPPED'\n| summarize count() by SrcUserName\n| extend AccountCustomEntity = SrcUserName\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for dropped outgoing mails."
              },
              {
                "name": "tactics",
                "value": "Exfiltration"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Cisco SEG Hunting Query 3",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Cisco SEG - DKIM failures",
            "category": "Hunting Queries",
            "query": "CiscoSEGEvent\n| where TimeGenerated > ago(24h)\n| where tostring(AdditionalFields) has 'ESADKIMVerdict'\n| extend dkim_status = extract(@'ESADKIMVerdict\":\"(Pass|Neutral|TempError|PermError|HardFail|None)\"', 1, tostring(AdditionalFields))\n| where dkim_status in~ ('PermError', 'HardFail', 'None')\n| extend AccountCustomEntity = SrcUserName\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for mails with DKIM failure status."
              },
              {
                "name": "tactics",
                "value": "InitialAccess"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Cisco SEG Hunting Query 4",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Cisco SEG - DMARK failures",
            "category": "Hunting Queries",
            "query": "CiscoSEGEvent\n| where TimeGenerated > ago(24h)\n| where tostring(AdditionalFields) has 'ESADMARCVerdict'\n| extend dmark_status = extract(@'ESADMARCVerdict\":\"(PermFailure|TempFailure|Reject|Success)\"', 1, tostring(AdditionalFields))\n| where dmark_status in~ ('PermFailure', 'TempFailure', 'Reject')\n| extend AccountCustomEntity = SrcUserName\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for mails with DMARK failure status."
              },
              {
                "name": "tactics",
                "value": "InitialAccess"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Cisco SEG Hunting Query 5",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Cisco SEG - SPF failures",
            "category": "Hunting Queries",
            "query": "CiscoSEGEvent\n| where TimeGenerated > ago(24h)\n| where tostring(AdditionalFields) has 'ESASPFVerdict'\n| extend spf_status = extract(@'ESASPFVerdict\":\"(Pass|Neutral|SoftFail|Fail|TempError|PermError)\"', 1, tostring(AdditionalFields))\n| where spf_status in~ ('Fail', 'TempError', 'PermError')\n| extend AccountCustomEntity = SrcUserName\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for mails with SPF failure status."
              },
              {
                "name": "tactics",
                "value": "InitialAccess"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Cisco SEG Hunting Query 6",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Cisco SEG - Failed incoming TLS connections",
            "category": "Hunting Queries",
            "query": "CiscoSEGEvent\n| where TimeGenerated > ago(24h)\n| where tostring(AdditionalFields) has 'ESATLSInConnStatus'\n| extend tls_status = extract(@'ESATLSInConnStatus\":\"(Success|Failure)\"', 1, tostring(AdditionalFields))\n| where tls_status =~ 'Failure'\n| extend AccountCustomEntity = DstUserName\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches failed TLS incoming connections."
              },
              {
                "name": "tactics",
                "value": "InitialAccess"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Cisco SEG Hunting Query 7",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Cisco SEG - Failed outgoing TLS connections",
            "category": "Hunting Queries",
            "query": "CiscoSEGEvent\n| where TimeGenerated > ago(24h)\n| where tostring(AdditionalFields) has 'ESATLSOutConnStatus'\n| extend tls_status = extract(@'ESATLSOutConnStatus\":\"(Success|Failure)\"', 1, tostring(AdditionalFields))\n| where tls_status =~ 'Failure'\n| extend AccountCustomEntity = SrcUserName\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches failed TLS outgoing connections."
              },
              {
                "name": "tactics",
                "value": "Impact"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Cisco SEG Hunting Query 8",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Cisco SEG - Insecure protocol",
            "category": "Hunting Queries",
            "query": "CiscoSEGEvent\n| where TimeGenerated > ago(24h)\n| where tostring(AdditionalFields) has 'ESATLSOutProtocol'\n| extend tls_status = extract(@'ESATLSOutProtocol\":\"(.*?)\"', 1, tostring(AdditionalFields))\n| where dlp_verdict != 'TLSv1.2'\n| extend AccountCustomEntity = SrcUserName\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for connections with insecure protocol."
              },
              {
                "name": "tactics",
                "value": "Impact"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Cisco SEG Hunting Query 9",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Cisco SEG - Sources of spam mails",
            "category": "Hunting Queries",
            "query": "CiscoSEGEvent\n| where TimeGenerated > ago(24h)\n| where NetworkDirection =~ 'Incoming'\n| where SimplifiedDeviceAction =~ 'QUARANTINED'\n| extend act_det = extract(@'ESAFinalActionDetails\":\"(.*?)\"', 1, tostring(AdditionalFields))\n| where act_det has 'To SPAM'\n| summarize count by SrcIpAddr\n| extend IPCustomEntity = SrcIpAddr\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for sources of spam mails."
              },
              {
                "name": "tactics",
                "value": "InitialAccess"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Cisco SEG Hunting Query 10",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Cisco SEG - Top users receiving spam mails",
            "category": "Hunting Queries",
            "query": "CiscoSEGEvent\n| where TimeGenerated > ago(24h)\n| where NetworkDirection =~ 'Incoming'\n| where SimplifiedDeviceAction =~ 'QUARANTINED'\n| extend act_det = extract(@'ESAFinalActionDetails\":\"(.*?)\"', 1, tostring(AdditionalFields))\n| where act_det has 'To SPAM'\n| summarize count by DstUserName\n| extend AccountCustomEntity = DstUserName\n",
            "version": 1,
            "tags": [
              {
                "name": "description",
                "value": "Query searches for top users receiving spam mails."
              },
              {
                "name": "tactics",
                "value": "InitialAccess"
              }
            ]
          }
        },
        {
          "type": "savedSearches",
          "apiVersion": "2020-08-01",
          "name": "Cisco SEG Data Parser",
          "dependsOn": [
            "[variables('workspace-dependency')]"
          ],
          "properties": {
            "eTag": "*",
            "displayName": "Cisco SEG Data Parser",
            "category": "Samples",
            "functionAlias": "CiscoSEGEvent",
            "query": "\nCommonSecurityLog\r\n| where DeviceEventClassID =~ 'ESA_CONSOLIDATED_LOG_EVENT'\r\n| extend EventStartTime = todatetime(extract(@\"startTime=(\\w{3}\\s\\w{3}\\s\\d{1,2}\\s\\d{2}:\\d{2}:\\d{2}\\s\\d{4})\", 1, AdditionalExtensions))\r\n| extend EventEndTime = todatetime(extract(@\"endTime=(\\w{3}\\s\\w{3}\\s\\d{1,2}\\s\\d{2}:\\d{2}:\\d{2}\\s\\d{4})\", 1, AdditionalExtensions))\r\n| extend NetworkDirection = case(CommunicationDirection == '0', 'Incoming', 'Outgoing')\r\n| extend EventType = Activity\r\n| extend FileName = extract(@\"ESAAttachmentDetails=\\{\\'(.*?)\\'\", 1, AdditionalExtensions)\r\n| extend FileHashSha256 = extract(@\"\\'fileHash\\':\\s?\\'(.*?)\\'\", 1, AdditionalExtensions)\r\n| extend FileSize = toint(extract(@\"\\'fsize\\':\\s?(\\d+)\", 1, AdditionalExtensions))\r\n| extend EventStatus = extract(@\"ESADaneStatus=(success|failure)\", 1, AdditionalExtensions)\r\n| extend DvcHostname = extract(@\"ESADaneHost=(\\S+)\", 1, AdditionalExtensions)\r\n| extend AdditionalFields = extract_all(@\"(?P<key>[a-zA-Z0-9- ]+)=(?P<value>[a-zA-Z0-9-_:/@.#{}'' ]+)\", dynamic([\"key\",\"value\"]), tostring(AdditionalExtensions))\r\n| mv-apply AdditionalFields on (\r\n    summarize AdditionalFields = make_list(pack(tostring(AdditionalFields[0]), AdditionalFields[1]))\r\n    )\r\n| project-rename EventVendor = DeviceVendor\r\n               , EventProduct = DeviceProduct\r\n               , EventId = DeviceEventClassID\r\n               , EventSeverity = LogSeverity\r\n               , DvcAction = DeviceAction\r\n               , DvcIpAddr = DeviceAddress\r\n               , EventMessage = Message\r\n               , EventProductVersion = DeviceVersion\r\n               , SerialNumber = DeviceExternalID\r\n               , DvcInboundInterface = DeviceInboundInterface\r\n               , DvcOutboundInterface = DeviceOutboundInterface\r\n               , DstUserName = DestinationUserName\r\n               , SrcUserName = SourceUserName\r\n               , MailPolicy = DeviceCustomString1\r\n               , SrcGeoCountry = DeviceCustomString2\r\n               , ThreatCategory = DeviceCustomString3\r\n               , EventOriginalUid = DeviceCustomString4\r\n               , MailLanguage = DeviceCustomString5\r\n               , SdrRepScore = DeviceCustomString6\r\n               , SbrsScore = DeviceCustomFloatingPoint1\r\n| project-away Activity\r\n             , DeviceCustomString1Label\r\n             , DeviceCustomString2Label\r\n             , DeviceCustomString3Label\r\n             , DeviceCustomString4Label\r\n             , DeviceCustomString5Label\r\n             , DeviceCustomString6Label\r\n             , DeviceCustomFloatingPoint1Label\r\n             , AdditionalExtensions\r\n",
            "version": 1
          }
        }
      ]
    },
    {
      "id": "[variables('_connector1-source')]",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',parameters('connector1-name'))]",
      "apiVersion": "2021-03-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
      "location": "[parameters('workspace-location')]",
      "kind": "GenericUI",
      "properties": {
        "connectorUiConfig": {
          "title": "Cisco Secure Email Gateway",
          "publisher": "Cisco",
          "descriptionMarkdown": "The [Cisco Secure Email Gateway (SEG)](https://www.cisco.com/c/en/us/products/security/email-security/index.html) data connector provides the capability to ingest [Cisco SEG Consolidated Event Logs](https://www.cisco.com/c/en/us/td/docs/security/esa/esa14-0/user_guide/b_ESA_Admin_Guide_14-0/b_ESA_Admin_Guide_12_1_chapter_0100111.html#con_1061902) into Azure Sentinel.",
          "graphQueries": [
            {
              "metricName": "Total data received",
              "legend": "CiscoSEG",
              "baseQuery": "CiscoSEGEvent"
            }
          ],
          "sampleQueries": [
            {
              "description": "Top 10 Senders",
              "query": "CiscoSEGEvent\n | where isnotempty(SrcUserName)\n    | summarize count() by SrcUserName\n | top 10 by count_"
            }
          ],
          "dataTypes": [
            {
              "name": "CommonSecurityLog (CiscoSEG)",
              "lastDataReceivedQuery": "CiscoSEGEvent\n            | summarize Time = max(TimeGenerated)\n            | where isnotempty(Time)"
            }
          ],
          "connectivityCriterias": [
            {
              "type": "IsConnectedQuery",
              "value": [
                "CiscoSEGEvent\n            | summarize LastLogReceived = max(TimeGenerated)\n            | project IsConnected = LastLogReceived > ago(30d)"
              ]
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": true
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "read and write permissions are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              },
              {
                "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                "permissionsDisplayText": "read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                "providerDisplayName": "Keys",
                "scope": "Workspace",
                "requiredPermissions": {
                  "action": true
                }
              }
            ]
          },
          "instructionSteps": [
            {
              "description": ">**NOTE:** This data connector depends on a parser based on a Kusto Function to work as expected [**CiscoSEGEvent**](https://aka.ms/sentinel-CiscoSEG-parser) which is deployed with the Azure Sentinel Solution."
            },
            {
              "description": ">**NOTE:** This data connector has been developed using AsyncOS 14.0 for Cisco Secure Email Gateway"
            },
            {
              "description": "Install and configure the Linux agent to collect your Common Event Format (CEF) Syslog messages and forward them to Azure Sentinel.\n\n> Notice that the data from all regions will be stored in the selected workspace",
              "innerSteps": [
                {
                  "title": "1.1 Select or create a Linux machine",
                  "description": "Select or create a Linux machine that Azure Sentinel will use as the proxy between your security solution and Azure Sentinel this machine can be on your on-prem environment, Azure or other clouds."
                },
                {
                  "title": "1.2 Install the CEF collector on the Linux machine",
                  "description": "Install the Microsoft Monitoring Agent on your Linux machine and configure the machine to listen on the necessary port and forward messages to your Azure Sentinel workspace. The CEF collector collects CEF messages on port 514 TCP.\n\n> 1. Make sure that you have Python on your machine using the following command: python -version.\n\n> 2. You must have elevated permissions (sudo) on your machine.",
                  "instructions": [
                    {
                      "parameters": {
                        "fillWith": [
                          "WorkspaceId",
                          "PrimaryKey"
                        ],
                        "label": "Run the following command to install and apply the CEF collector:",
                        "value": "sudo wget -O cef_installer.py https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/DataConnectors/CEF/cef_installer.py&&sudo python cef_installer.py {0} {1}"
                      },
                      "type": "CopyableLabel"
                    }
                  ]
                }
              ],
              "title": "1. Linux Syslog agent configuration"
            },
            {
              "description": "Follow these steps to configure Cisco Secure Email Gateway to forward logs via syslog:\n\n2.1. Configure [Log Subscription](https://www.cisco.com/c/en/us/td/docs/security/esa/esa14-0/user_guide/b_ESA_Admin_Guide_14-0/b_ESA_Admin_Guide_12_1_chapter_0100111.html#con_1134718)\n\n>**NOTE:** Select **Consolidated Event Logs** in Log Type field.",
              "title": "2. Forward Common Event Format (CEF) logs to Syslog agent"
            },
            {
              "description": "Follow the instructions to validate your connectivity:\n\nOpen Log Analytics to check if the logs are received using the CommonSecurityLog schema.\n\n>It may take about 20 minutes until the connection streams data to your workspace.\n\nIf the logs are not received, run the following connectivity validation script:\n\n> 1. Make sure that you have Python on your machine using the following command: python -version\n\n>2. You must have elevated permissions (sudo) on your machine",
              "instructions": [
                {
                  "parameters": {
                    "fillWith": [
                      "WorkspaceId"
                    ],
                    "label": "Run the following command to validate your connectivity:",
                    "value": "sudo wget -O cef_troubleshoot.py https://raw.githubusercontent.com/Azure/Azure-Sentinel/master/DataConnectors/CEF/cef_troubleshoot.py&&sudo python cef_troubleshoot.py  {0}"
                  },
                  "type": "CopyableLabel"
                }
              ],
              "title": "3. Validate connection"
            },
            {
              "description": "Make sure to configure the machine's security according to your organization's security policy\n\n\n[Learn more >](https://aka.ms/SecureCEF)",
              "title": "4. Secure your machine "
            }
          ],
          "additionalRequirementBanner": "This data connector depends on a parser based on a Kusto Function to work as expected [**CiscoSEGEvent**](https://aka.ms/sentinel-CiscoSEG-parser) which is deployed with the Azure Sentinel Solution."
        }
      }
    },
    {
      "type": "Microsoft.Insights/workbooks",
      "name": "[parameters('workbook1-id')]",
      "location": "[parameters('workspace-location')]",
      "kind": "shared",
      "apiVersion": "2020-02-12",
      "properties": {
        "displayName": "[concat(parameters('workbook1-name'), ' - ', parameters('formattedTimeNow'))]",
        "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"**NOTE**: This data connector depends on a parser based on Kusto Function **CiscoSEGEvent** to work as expected. [Follow steps to get this Kusto Function](https://aka.ms/sentinel-ciscoseg-parser)\"},\"name\":\"text - 8\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"cd8447d9-b096-4673-92d8-2a1e8291a125\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"TimeRange\",\"type\":4,\"description\":\"Sets the time name for analysis\",\"value\":{\"durationMs\":7776000000},\"typeSettings\":{\"selectableValues\":[{\"durationMs\":900000},{\"durationMs\":3600000},{\"durationMs\":86400000},{\"durationMs\":604800000},{\"durationMs\":2592000000},{\"durationMs\":7776000000}]},\"timeContext\":{\"durationMs\":86400000}}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 11\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CiscoSEGEvent\\r\\n| make-series TotalEvents = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain};\",\"size\":0,\"title\":\"Events Over Time\",\"color\":\"orange\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"timechart\",\"graphSettings\":{\"type\":0}},\"customWidth\":\"50\",\"name\":\"query - 12\",\"styleSettings\":{\"maxWidth\":\"55\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let tot_m = CiscoSEGEvent\\r\\n| summarize e_count=count()\\r\\n| extend Title='Total Mails';\\r\\nlet rec = CiscoSEGEvent\\r\\n| where NetworkDirection =~ 'Incoming'\\r\\n| where SimplifiedDeviceAction =~ 'DELIVERED'\\r\\n| summarize e_count=count()\\r\\n| extend Title='Mails Delivered';\\r\\nlet q_m = CiscoSEGEvent\\r\\n| where NetworkDirection =~ 'Incoming'\\r\\n| where SimplifiedDeviceAction =~ 'QUARANTINED'\\r\\n| summarize e_count=count()\\r\\n| extend Title='Quarantined Mails';\\r\\nlet mal_m = CiscoSEGEvent\\r\\n| where NetworkDirection =~ 'Incoming'\\r\\n| where tostring(AdditionalFields) has 'ESAAMPVerdict'\\r\\n| extend amp_verdict = extract(@'ESAAMPVerdict\\\":\\\"(NOT_EVALUATED|CLEAN|FA_PENDING|UNKNOWN|SKIPPED|UNSCANNABLE|LOW_RISK|MALICIOUS)\\\"', 1, tostring(AdditionalFields))\\r\\n| where amp_verdict =~ 'MALICIOUS'\\r\\n| summarize e_count=count()\\r\\n| extend Title='Malicious Mails';\\r\\nunion isfuzzy=true tot_m, rec, q_m, mal_m\\r\\n| order by e_count\",\"size\":3,\"title\":\"Mail Summary\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"Title\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"e_count\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"style\":\"decimal\",\"maximumFractionDigits\":2,\"maximumSignificantDigits\":3}}},\"secondaryContent\":{\"columnMatch\":\"Trend\",\"formatter\":9,\"formatOptions\":{\"palette\":\"purple\"}},\"showBorder\":false}},\"customWidth\":\"20\",\"name\":\"query - 0\",\"styleSettings\":{\"maxWidth\":\"30\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CiscoSEGEvent\\n| where NetworkDirection =~ 'Incoming'\\n| summarize tot_m = count() by DstUserName\\n| join kind = inner (CiscoSEGEvent\\n | make-series Trend = count() default = 0 on TimeGenerated from {TimeRange:start} to {TimeRange:end} step {TimeRange:grain} by DstUserName)\\n on DstUserName\\n| project-away DstUserName1, TimeGenerated\\n| project User = DstUserName, TotalMailsReceived=tot_m, Trend\\n| order by TotalMailsReceived\\n| take 6\",\"size\":0,\"title\":\"Users' mail volume\",\"timeContext\":{\"durationMs\":86400000},\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"tiles\",\"tileSettings\":{\"titleContent\":{\"columnMatch\":\"User\",\"formatter\":1},\"leftContent\":{\"columnMatch\":\"TotalMailsReceived\",\"formatter\":12,\"formatOptions\":{\"palette\":\"auto\"},\"numberFormat\":{\"unit\":17,\"options\":{\"maximumSignificantDigits\":3,\"maximumFractionDigits\":2}}},\"secondaryContent\":{\"columnMatch\":\"Trend\",\"formatter\":10,\"formatOptions\":{\"palette\":\"magenta\"}},\"showBorder\":false}},\"customWidth\":\"30\",\"name\":\"query - 10\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CiscoSEGEvent\\r\\n| where NetworkDirection =~ 'Outgoing'\\r\\n| where isnotempty(SrcUserName)\\r\\n| summarize count() by SrcUserName\\r\\n| top 10 by count_\",\"size\":3,\"title\":\"Top Senders\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"33\",\"name\":\"query - 3\",\"styleSettings\":{\"margin\":\"10\",\"padding\":\"10\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CiscoSEGEvent\\r\\n| where NetworkDirection =~ 'Incoming'\\r\\n| where isnotempty(DstUserName)\\r\\n| summarize count() by DstUserName\\r\\n| top 10 by count_\",\"size\":3,\"title\":\"Top Recipients\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"gridSettings\":{\"sortBy\":[{\"itemKey\":\"TotalEvents\",\"sortOrder\":2}]},\"sortBy\":[{\"itemKey\":\"TotalEvents\",\"sortOrder\":2}]},\"customWidth\":\"33\",\"name\":\"query - 2\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CiscoSEGEvent\\r\\n| where NetworkDirection =~ 'Incoming'\\r\\n| where SimplifiedDeviceAction =~ 'DELIVERED'\\r\\n| where tostring(AdditionalFields) has 'ESAAMPVerdict'\\r\\n| extend amp_verdict = extract(@'ESAAMPVerdict\\\":\\\"(NOT_EVALUATED|CLEAN|FA_PENDING|UNKNOWN|SKIPPED|UNSCANNABLE|LOW_RISK|MALICIOUS)\\\"', 1, tostring(AdditionalFields))\\r\\n| where amp_verdict =~ 'UNSCANNABLE'\\r\\n| extend Filename = replace_string(tostring(extract(@'\\\"ESAAttachmentDetails\\\":\\\"{(.*?):', 1, tostring(AdditionalFields))), \\\"'\\\", \\\"\\\")\\r\\n| order by TimeGenerated\\r\\n| project TimeGenerated, DstUserName, Filename\\r\\n\",\"size\":3,\"title\":\"Unscannable Files\",\"timeContext\":{\"durationMs\":7776000000},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"table\"},\"customWidth\":\"34\",\"name\":\"query - 1\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CiscoSEGEvent\\r\\n| where NetworkDirection =~ 'Incoming'\\r\\n| where SimplifiedDeviceAction =~ 'DELIVERED'\\r\\n| where tostring(AdditionalFields) has 'ESAAMPVerdict'\\r\\n| extend amp_verdict = extract(@'ESAAMPVerdict\\\":\\\"(NOT_EVALUATED|CLEAN|FA_PENDING|UNKNOWN|SKIPPED|UNSCANNABLE|LOW_RISK|MALICIOUS)\\\"', 1, tostring(AdditionalFields))\\r\\n| where amp_verdict =~ 'MALICIOUS'\\r\\n| extend Filename = replace_string(tostring(extract(@'\\\"ESAAttachmentDetails\\\":\\\"{(.*?):', 1, tostring(AdditionalFields))), \\\"'\\\", \\\"\\\")\\r\\n| summarize count() by Filename\\r\\n\",\"size\":3,\"title\":\"Top Malicious Attachments\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"gridSettings\":{\"rowLimit\":50,\"filter\":true}},\"customWidth\":\"30\",\"name\":\"query - 8\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CiscoSEGEvent\\r\\n  | where NetworkDirection =~ 'Outgoing'\\r\\n  | where tostring(AdditionalFields) has 'ESADLPVerdict'\\r\\n  | extend dlp_verdict = extract(@'ESADLPVerdict\\\":\\\"(NOT_EVALUATED|NO TRIGGER|VIOLATION|NO VIOLATION)\\\"', 1, tostring(AdditionalFields))\\r\\n  | where dlp_verdict =~ 'VIOLATION'\\r\\n  | extend File = replace_string(tostring(extract(@'\\\"ESAAttachmentDetails\\\":\\\"{(.*?):', 1, tostring(AdditionalFields))), \\\"'\\\", \\\"\\\")\\r\\n  | project TimeGenerated, SrcUserName, DstUserName, File\",\"size\":0,\"title\":\"Users with DLP Violation\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"rowLimit\":50}},\"customWidth\":\"40\",\"name\":\"query - 12\",\"styleSettings\":{\"maxWidth\":\"33\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"CiscoSEGEvent\\n  | where TimeGenerated > ago(24h)\\n  | where NetworkDirection =~ 'Incoming'\\n  | extend act_det = extract(@'ESAFinalActionDetails\\\":\\\"(.*?)\\\"', 1, tostring(AdditionalFields))\\n  | where act_det has 'To SPAM'\\n  | summarize count() by SrcUserName\\n  | top 10 by count_\\n\",\"size\":3,\"title\":\"SPAM Sources\",\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\"},\"customWidth\":\"30\",\"name\":\"query - 10\"}],\"fromTemplateId\":\"sentinel-CiscoSEGWorkbook\",\"$schema\":\"https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json\"}\r\n",
        "version": "1.0",
        "sourceId": "[variables('_workbook-source')]",
        "category": "sentinel"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "apiVersion": "2021-03-01-preview",
      "properties": {
        "version": "1.0.3",
        "kind": "Solution",
        "contentId": "[variables('_sourceId')]",
        "parentId": "[variables('_sourceId')]",
        "source": {
          "kind": "Solution",
          "name": "Cisco SEG",
          "sourceId": "[variables('_sourceId')]"
        },
        "author": {
          "name": "Nikhil Tripathi",
          "email": "v-ntripathi@microsoft.com"
        },
        "support": {
          "name": "Microsoft Corporation",
          "email": "support@microsoft.com",
          "tier": "Microsoft",
          "link": "https://support.microsoft.com"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoSEGDLPViolation_AnalyticalRules')]",
              "version": "1.0.3"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoSEGMaliciousAttachmentNotBlocked_AnalyticalRules')]",
              "version": "1.0.3"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoSEGMultipleLargeEmails_AnalyticalRules')]",
              "version": "1.0.3"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoSEGMultipleSuspiciousEmails_AnalyticalRules')]",
              "version": "1.0.3"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoSEGPossibleOutbreak_AnalyticalRules')]",
              "version": "1.0.3"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoSEGPotentialLinkToMalwareDownload_AnalyticalRules')]",
              "version": "1.0.3"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoSEGSuspiciousLink_AnalyticalRules')]",
              "version": "1.0.3"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoSEGSuspiciousSenderDomain_AnalyticalRules')]",
              "version": "1.0.3"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoSEGUnclassifiedLink_AnalyticalRules')]",
              "version": "1.0.3"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoSEGUnexpextedAttachment_AnalyticalRules')]",
              "version": "1.0.3"
            },
            {
              "kind": "AnalyticsRule",
              "contentId": "[variables('_CiscoSEGUnscannableAttachment_AnalyticalRules')]",
              "version": "1.0.3"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoSEGDroppedInMails_HuntingQueries')]",
              "version": "1.0.3"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoSEGDroppedOutMails_HuntingQueries')]",
              "version": "1.0.3"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoSEGFailedDKIMFailure_HuntingQueries')]",
              "version": "1.0.3"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoSEGFailedDMARKFailure_HuntingQueries')]",
              "version": "1.0.3"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoSEGFailedSPFFailure_HuntingQueries')]",
              "version": "1.0.3"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoSEGFailedTLSIn_HuntingQueries')]",
              "version": "1.0.3"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoSEGFailedTLSOut_HuntingQueries')]",
              "version": "1.0.3"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoSEGInsecureProtocol_HuntingQueries')]",
              "version": "1.0.3"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoSEGSpamMails_HuntingQueries')]",
              "version": "1.0.3"
            },
            {
              "kind": "HuntingQuery",
              "contentId": "[variables('_CiscoSEGUsersReceivedSpam_HuntingQueries')]",
              "version": "1.0.3"
            },
            {
              "kind": "Parser",
              "contentId": "[variables('_CiscoSEGEvent_Parser')]",
              "version": "1.0.3"
            },
            {
              "kind": "DataConnector",
              "contentId": "[variables('_CiscoSEGConnector')]",
              "version": "1.0.3"
            },
            {
              "kind": "Workbook",
              "contentId": "[variables('_CiscoSEG_workbook')]",
              "version": "1.0.3"
            }
          ]
        },
        "firstPublishDate": "2021-06-23",
        "providers": [
          "Cisco"
        ],
        "categories": {
          "domains": [
            "Security - Threat Protection"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_sourceId'))]"
    }
  ],
  "outputs": {}
}
